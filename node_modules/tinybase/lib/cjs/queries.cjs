"use strict";const e=e=>typeof e,t=e(""),n=e(!0),s=e(0),r=e(e),o=(e,t)=>e.every(t),a=(e,t)=>e.forEach(t),l=e=>c(e,((e,t)=>e+t),0),i=e=>e.length,d=e=>0==i(e),c=(e,t,n)=>e.reduce(t,n),u=(e,...t)=>e.push(...t),h=Math.max,w=Math.min,g=isFinite,R=e=>null==e,v=(e,t,n)=>R(e)?n?.():t(e),L=t=>e(t)==r,f=e=>Array.isArray(e),y=()=>{},T=e=>e.size,b=(e,t)=>e?.has(t)??!1,C=e=>R(e)||0==T(e),p=e=>[...e?.values()??[]],I=e=>e.clear(),m=(e,t)=>e?.forEach(t),Q=(e,t)=>e?.delete(t),S=e=>new Map(e),E=(e,t)=>e?.get(t),M=(e,t)=>m(e,((e,n)=>t(n,e))),x=(e,t,n)=>R(n)?(Q(e,t),e):e?.set(t,n),D=(e,t,n)=>(b(e,t)||x(e,t,n()),E(e,t)),F=(e,t,n,s,r=0)=>v((n?D:E)(e,t[r],r>i(t)-2?n:S),(o=>{if(r>i(t)-2)return s?.(o)&&x(e,t[r]),o;const a=F(o,t,n,s,r+1);return C(o)&&x(e,t[r]),a})),j=e=>new Set(f(e)||R(e)?e:[e]),k=(e,t)=>e?.add(t),z=S([["avg",[(e,t)=>l(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,s)=>e+(t-n)/s]],["max",[e=>h(...e),(e,t)=>h(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:h(t,e)]],["min",[e=>w(...e),(e,t)=>w(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:w(t,e)]],["sum",[e=>l(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),A=Object,W=A.freeze,O=(r=>{const l=new WeakMap;return r=>(l.has(r)||l.set(r,(r=>{const l=r.createStore,[c,h,w,O,q,,,B,,G,H,J,K]=((e,t,n)=>{const s=e.hasRow,r=S(),l=S(),c=S(),u=S(),h=S(),w=(t,n,...s)=>{const r=D(h,t,j);return a(s,(t=>k(r,t)&&n&&e.callListener(t))),s},g=(t,...n)=>v(E(h,t),(s=>{a(d(n)?p(s):n,(t=>{e.delListener(t),Q(s,t)})),C(s)&&x(h,t)})),L=(e,t)=>{x(r,e,t),b(l,e)||(x(l,e,!0),x(c,e,S()),x(u,e,S()))},y=e=>{x(r,e),x(l,e),x(c,e),x(u,e),g(e)};return[()=>e,()=>[...r?.keys()??[]],e=>M(l,e),e=>b(l,e),e=>E(r,e),e=>E(l,e),(e,t)=>x(l,e,t),L,(t,r,l,d,h)=>{L(t,r);const v=S(),y=S(),T=E(c,t),C=E(u,t),p=t=>{const a=n=>e.getCell(r,t,n),l=E(T,t),c=s(r,t)?n(d(a,t)):void 0;var u,w;if(l===c||f(l)&&f(c)&&(w=c,i(u=l)===i(w)&&o(u,((e,t)=>w[t]===e)))||x(v,t,[l,c]),!R(h)){const e=E(C,t),n=s(r,t)?h(a,t):void 0;e!=n&&x(y,t,n)}},Q=e=>{l((()=>{m(v,(([,e],t)=>x(T,t,e))),m(y,((e,t)=>x(C,t,e)))}),v,y,T,C,e),I(v),I(y)};M(T,p),e.hasTable(r)&&a(e.getRowIds(r),(e=>{b(T,e)||p(e)})),Q(!0),g(t),w(t,0,e.addRowListener(r,null,((e,t,n)=>p(n))),e.addTableListener(r,(()=>Q())))},y,()=>M(h,y),w,g]})(r,0,y),N=l(),P=l(),U=S(),V=(e,t,...n)=>a(n,(n=>k(D(D(U,t,S),e,j),n))),X=e=>{v(E(U,e),(e=>{M(e,((e,t)=>m(t,(t=>e.delListener(t))))),I(e)})),a([P,N],(t=>t.delTable(e)))},Y=(e,t,n)=>V(t,e,t.addWillFinishTransactionListener(n.startTransaction),t.addDidFinishTransactionListener((()=>n.finishTransaction()))),Z={setQueryDefinition:(l,c,h)=>{B(l,c),X(l);const w=[],f=[[null,[c,null,null,[],S()]]],y=[],I=[],A=[];h({select:(e,t)=>{const n=L(e)?[i(w)+"",e]:[R(t)?e:t,n=>n(e,t)];return u(w,n),{as:e=>n[0]=e}},join:(e,t,n)=>{const s=R(n)||L(t)?null:t,r=R(s)?t:n,o=[e,[e,s,L(r)?r:e=>e(r),[],S()]];return u(f,o),{as:e=>o[0]=e}},where:(e,t,n)=>u(y,L(e)?e:R(n)?n=>n(e)===t:s=>s(e,t)===n),group:(e,t,n,s,r)=>{const o=[e,[e,L(t)?[t,n,s,r]:E(z,t)??[(e,t)=>t]]];return u(I,o),{as:e=>o[0]=e}},having:(e,t)=>u(A,L(e)?e:n=>n(e)===t)});const W=S(w);if(C(W))return Z;const O=S(f);M(O,((e,[,t])=>v(E(O,t),(({3:t})=>R(e)?0:u(t,e)))));const q=S(I);let G=N;if(C(q)&&d(A))G=P;else{Y(l,G,P);const r=S();M(q,((e,[t,n])=>k(D(r,t,j),[e,n])));const a=j();M(W,(e=>b(r,e)?0:k(a,e)));const i=S(),d=(a,i,d,c)=>v(a,(([u,h,w,v])=>{M(i,((o,[a])=>{const l=D(u,o,S),i=E(l,d),h=c?void 0:a;if(i!==h){const a=j([[i,h]]),c=T(l);x(l,d,h),m(E(r,o),(([r,o])=>{const i=((e,t,n,s,r,o=!1)=>{if(C(n))return;const[a,l,i,d]=r;return o||=R(e),m(s,(([n,s])=>{o||(e=R(n)?l?.(e,s,t++):R(s)?i?.(e,n,t--):d?.(e,s,n,t),o||=R(e))})),o?a(p(n),T(n)):e})(v[r],c,l,a,o);v[r]=R((r=>{const o=e(r);return(e=>e==t||e==n)(o)||o==s&&g(r)?o:void 0})(i))?null:i}))}})),C(h)||!o(A,(e=>e((e=>v[e]))))?P.delRow(l,w):R(w)?a[2]=P.addRow(l,v):P.setRow(l,w,v)}));V(G,l,G.addRowListener(l,null,((e,t,n,s)=>{const o=[],c=[],h=S(),w=G.hasRow(l,n);let g=!w;m(a,(e=>{const[t,r,a]=s(l,n,e);u(o,r),u(c,a),g||=t})),M(r,(e=>{const[t,,r]=s(l,n,e);(g||t)&&x(h,e,[r])})),g&&d(F(i,o,void 0,(([,e])=>(Q(e,n),C(e)))),h,n,1),w&&d(F(i,c,(()=>{const e={};return m(a,(t=>e[t]=G.getCell(l,n,t))),[S(),j(),void 0,e]}),(([,e])=>{k(e,n)})),h,n)})))}Y(l,r,G);const H=(e,t,n,s)=>{const i=e=>r.getCell(t,n,e);a(s,(t=>{const[n,,s,o,a]=E(O,t),d=s?.(i,e),[c,u]=E(a,e)??[];d!=c&&(R(u)||K(l,u),x(a,e,R(d)?null:[d,...J(l,1,r.addRowListener(n,d,(()=>H(e,n,d,o))))]))})),(e=>{const t=(t,n)=>r.getCell(...R(n)?[c,e,t]:t===c?[c,e,n]:[E(O,t)?.[0],E(E(O,t)?.[4],e)?.[0],n]);G.transaction((()=>o(y,(e=>e(t)))?M(W,((n,s)=>((e,t,n,s,r)=>R(r)?e.delCell(t,n,s,!0):e.setCell(t,n,s,r))(G,l,e,n,s(t,e)))):G.delRow(l,e)))})(e)},{3:U}=E(O,null);return G.transaction((()=>J(l,1,r.addRowListener(c,null,((e,t,n)=>{r.hasRow(c,n)?H(n,c,n,U):(G.delRow(l,n),m(O,(({4:e})=>v(E(e,n),(([,t])=>{K(l,t),x(e,n)})))))}))))),Z},delQueryDefinition:e=>(X(e),G(e),Z),getStore:c,getQueryIds:h,forEachQuery:w,hasQuery:O,getTableId:q,delListener:e=>(P.delListener(e),Z),destroy:H,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:n,...s}=P.getListenerStats();return s}};var $,_;return $={Table:[1,1],RowIds:[0,1],SortedRowIds:[0,5],Row:[1,2],CellIds:[0,2],Cell:[1,3]},_=([e,t],n)=>{a(e?["get","has","forEach"]:["get"],(e=>Z[e+"Result"+n]=(...t)=>P[e+n](...t))),Z["addResult"+n+"Listener"]=(...e)=>{return P["add"+n+"Listener"](...(s=e,0,r=t,s.slice(0,r)),((n,...s)=>e[t](Z,...s)));var s,r}},((e,t)=>{e.map(t)})(A.entries($),(([e,t])=>_(t,e))),W(Z)})(r)),l.get(r))})();exports.createQueries=O;
