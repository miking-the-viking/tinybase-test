"use strict";const e=e=>typeof e,t=e(""),s=(e,t)=>e.forEach(t),n=e=>e.length,o=(e,...t)=>e.push(...t),r=e=>null==e,i=(e,t,s)=>r(e)?s?.():t(e),a=e=>Array.isArray(e),l=(e,t)=>e?.has(t)??!1,d=e=>r(e)||0==(e=>e.size)(e),c=e=>[...e?.values()??[]],u=e=>e.clear(),R=(e,t)=>e?.forEach(t),h=(e,t)=>e?.delete(t),f=e=>new Map(e),L=(e,t)=>e?.get(t),g=(e,t)=>R(e,((e,s)=>t(s,e))),w=(e,t,s)=>r(s)?(h(e,t),e):e?.set(t,s),p=(e,t,s)=>(l(e,t)||w(e,t,s()),L(e,t)),I=(e,t,s,o,r=0)=>i((s?p:L)(e,t[r],r>n(t)-2?s:f),(i=>{if(r>n(t)-2)return o?.(i)&&w(e,t[r]),i;const a=I(i,t,s,o,r+1);return d(i)&&w(e,t[r]),a})),v=e=>new Set(a(e)||r(e)?e:[e]),y=(e,t)=>e?.add(t),b=/^\d+$/,k=Object.freeze,E=(E=>{const T=new WeakMap;return E=>(T.has(E)||T.set(E,(E=>{const T=f(),m=f(),S=f(),z=f(),[A,D,M,j,x,C,,,O,W,$]=((e,t,o)=>{const I=e.hasRow,b=f(),k=f(),E=f(),T=f(),m=f(),S=(t,n,...o)=>{const r=p(m,t,v);return s(o,(t=>y(r,t)&&n&&e.callListener(t))),o},z=(t,...o)=>i(L(m,t),(r=>{s(0==n(o)?c(r):o,(t=>{e.delListener(t),h(r,t)})),d(r)&&w(m,t)})),A=(e,t)=>{w(b,e,t),l(k,e)||(w(k,e,[f(),f(),f(),f()]),w(E,e,f()),w(T,e,f()))},D=e=>{w(b,e),w(k,e),w(E,e),w(T,e),z(e)};return[()=>e,()=>[...b?.keys()??[]],e=>g(k,e),e=>l(k,e),e=>L(b,e),e=>L(k,e),(e,t)=>w(k,e,t),A,(t,o,i,d,c)=>{A(t,o);const h=f(),p=f(),v=L(E,t),y=L(T,t),b=t=>{const s=s=>e.getCell(o,t,s),i=L(v,t),l=I(o,t)?(u=d(s,t),r(u)?void 0:u+""):void 0;var u,R,f,g;if(i===l||a(i)&&a(l)&&(f=l,n(R=i)===n(f)&&(g=(e,t)=>f[t]===e,R.every(g)))||w(h,t,[i,l]),!r(c)){const e=L(y,t),n=I(o,t)?c(s,t):void 0;e!=n&&w(p,t,n)}},k=e=>{i((()=>{R(h,(([,e],t)=>w(v,t,e))),R(p,((e,t)=>w(y,t,e)))}),h,p,v,y,e),u(h),u(p)};g(v,b),e.hasTable(o)&&s(e.getRowIds(o),(e=>{l(v,e)||b(e)})),k(!0),z(t),S(t,0,e.addRowListener(o,null,((e,t,s)=>b(s))),e.addTableListener(o,(()=>k())))},D,()=>g(m,D),S,z]})(E),[q,B,F]=(e=>{let t;const[a,l]=(()=>{const e=[];let t=0;return[()=>e.shift()??""+t++,t=>{b.test(t)&&n(e)<1e3&&o(e,t)}]})(),c=f();return[(e,s,n,o=[],r=(()=>[]))=>{t??=K;const i=a();return w(c,i,[e,s,n,o,r]),y(I(s,n??[""],v),i),i},(e,r,...i)=>s(((e,t=[""])=>{const r=[],i=(e,a)=>a==n(t)?o(r,e):null===t[a]?R(e,(e=>i(e,a+1))):s([t[a],null],(t=>i(L(e,t),a+1)));return i(e,0),r})(e,r),(e=>R(e,(e=>L(c,e)[0](t,...r??[],...i))))),e=>i(L(c,e),(([,t,s])=>(I(t,s??[""],void 0,(t=>(h(t,e),d(t)?1:0))),w(c,e),l(e),s))),e=>i(L(c,e),(([e,,o=[],i,a])=>{const l=(...d)=>{const c=n(d);c==n(o)?e(t,...d,...a(d)):r(o[c])?s(i[c]?.(...d)??[],(e=>l(...d,e))):l(...d,o[c])};l()}))]})(),G=(e,t,s)=>i(C(e),(([n,,o])=>{if(!l(o,t)){const i=v();if(x(e)!=J(e))y(i,t);else{let e=t;for(;!r(e)&&!l(i,e);)y(i,e),e=L(n,e)}if(s)return i;w(o,t,i)}return L(o,t)})),H=(e,t)=>i(C(e),(([,,e])=>w(e,t))),J=e=>L(T,e),K={setRelationshipDefinition:(s,n,o,a)=>{return w(T,s,o),O(s,n,((e,t)=>{const n=v(),o=v(),a=v(),[c,u]=C(s);R(t,(([e,t],R)=>{r(e)||(y(o,e),i(L(u,e),(t=>{h(t,R),d(t)&&w(u,e)}))),r(t)||(y(o,t),l(u,t)||w(u,t,v()),y(L(u,t),R)),y(n,R),w(c,R,t),g(L(z,s),(e=>{l(G(s,e),R)&&y(a,e)}))})),e(),R(n,(e=>B(m,[s,e]))),R(o,(e=>B(S,[s,e]))),R(a,(e=>{H(s,e),B(z,[s,e])}))}),e(c=a)==t?e=>e(c):c??(()=>"")),K;var c},delRelationshipDefinition:e=>(w(T,e),W(e),K),getStore:A,getRelationshipIds:D,forEachRelationship:e=>M((t=>e(t,(e=>E.forEachRow(x(t),e))))),hasRelationship:j,getLocalTableId:x,getRemoteTableId:J,getRemoteRowId:(e,t)=>L(C(e)?.[0],t),getLocalRowIds:(e,t)=>c(L(C(e)?.[1],t)),getLinkedRowIds:(e,t)=>r(C(e))?[t]:c(G(e,t,!0)),addRemoteRowIdListener:(e,t,s)=>q(s,m,[e,t]),addLocalRowIdsListener:(e,t,s)=>q(s,S,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(G(e,t),q(s,z,[e,t])),delListener:e=>(H(...F(e)),K),destroy:$,getListenerStats:()=>({})};return k(K)})(E)),T.get(E))})();exports.createRelationships=E;
