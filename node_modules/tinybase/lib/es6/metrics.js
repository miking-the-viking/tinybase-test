const e=e=>typeof e,n=e(""),t=e(e),l=(e,n)=>e.forEach(n),r=e=>o(e,((e,n)=>e+n),0),i=e=>e.length,o=(e,n,t)=>e.reduce(n,t),u=(e,...n)=>e.push(...n),s=Math.max,d=Math.min,a=isFinite,v=e=>null==e,c=(e,n,t)=>v(e)?null==t?void 0:t():n(e),h=e=>Array.isArray(e),f=()=>{},g=e=>e.size,M=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},L=e=>v(e)||0==g(e),m=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},w=e=>e.clear(),y=(e,n)=>null==e?void 0:e.forEach(n),p=(e,n)=>null==e?void 0:e.delete(n),b=e=>new Map(e),x=(e,n)=>null==e?void 0:e.get(n),E=(e,n)=>y(e,((e,t)=>n(t,e))),I=(e,n,t)=>v(t)?(p(e,n),e):null==e?void 0:e.set(n,t),R=(e,n,t)=>(M(e,n)||I(e,n,t()),x(e,n)),S=(e,n,t,l,r=0)=>c((t?R:x)(e,n[r],r>i(n)-2?t:b),(o=>{if(r>i(n)-2)return(null==l?void 0:l(o))&&I(e,n[r]),o;const u=S(o,n,t,l,r+1);return L(o)&&I(e,n[r]),u})),T=b([["avg",[(e,n)=>r(e)/n,(e,n,t)=>e+(n-e)/(t+1),(e,n,t)=>e+(e-n)/(t-1),(e,n,t,l)=>e+(n-t)/l]],["max",[e=>s(...e),(e,n)=>s(n,e),(e,n)=>n==e?void 0:e,(e,n,t)=>t==e?void 0:s(n,e)]],["min",[e=>d(...e),(e,n)=>d(n,e),(e,n)=>n==e?void 0:e,(e,n,t)=>t==e?void 0:d(n,e)]],["sum",[e=>r(e),(e,n)=>e+n,(e,n)=>e-n,(e,n,t)=>e-t+n]]]),k=e=>new Set(h(e)||v(e)?e:[e]),z=(e,n)=>null==e?void 0:e.add(n),A=/^\d+$/,D=Object.freeze,N=(r=>{const o=new WeakMap;return r=>(o.has(r)||o.set(r,(r=>{const o=b(),[s,d,N,j,C,F,O,,W,$,q]=((e,n,t)=>{const r=e.hasRow,o=b(),u=b(),s=b(),d=b(),a=b(),f=(n,t,...r)=>{const i=R(a,n,k);return l(r,(n=>z(i,n)&&t&&e.callListener(n))),r},g=(n,...t)=>c(x(a,n),(r=>{l(0==i(t)?m(r):t,(n=>{e.delListener(n),p(r,n)})),L(r)&&I(a,n)})),S=(e,t)=>{I(o,e,t),M(u,e)||(I(u,e,n()),I(s,e,b()),I(d,e,b()))},T=e=>{I(o,e),I(u,e),I(s,e),I(d,e),g(e)};return[()=>e,()=>{return[...null!=(n=null==(e=o)?void 0:e.keys())?n:[]];var e,n},e=>E(u,e),e=>M(u,e),e=>x(o,e),e=>x(u,e),(e,n)=>I(u,e,n),S,(n,t,o,u,a)=>{S(n,t);const c=b(),L=b(),m=x(s,n),p=x(d,n),R=n=>{const l=l=>e.getCell(t,n,l),o=x(m,n),s=r(t,n)?(d=u(l,n),isNaN(d)||v(d)||!0===d||!1===d||""===d?void 0:1*d):void 0;var d,f,g,M;if(o===s||h(o)&&h(s)&&(g=s,i(f=o)===i(g)&&(M=(e,n)=>g[n]===e,f.every(M)))||I(c,n,[o,s]),!v(a)){const e=x(p,n),i=r(t,n)?a(l,n):void 0;e!=i&&I(L,n,i)}},T=e=>{o((()=>{y(c,(([,e],n)=>I(m,n,e))),y(L,((e,n)=>I(p,n,e)))}),c,L,m,p,e),w(c),w(L)};E(m,R),e.hasTable(t)&&l(e.getRowIds(t),(e=>{M(m,e)||R(e)})),T(!0),g(n),f(n,0,e.addRowListener(t,null,((e,n,t)=>R(t))),e.addTableListener(t,(()=>T())))},T,()=>E(a,T),f,g]})(r,f),[B,G,H]=(e=>{let n;const[t,r]=(()=>{const e=[];let n=0;return[()=>{var t;return null!=(t=e.shift())?t:""+n++},n=>{A.test(n)&&i(e)<1e3&&u(e,n)}]})(),o=b();return[(e,l,r,i=[],u=(()=>[]))=>{null!=n||(n=J);const s=t();return I(o,s,[e,l,r,i,u]),z(S(l,null!=r?r:[""],k),s),s},(e,t,...r)=>l(((e,n=[""])=>{const t=[],r=(e,o)=>o==i(n)?u(t,e):null===n[o]?y(e,(e=>r(e,o+1))):l([n[o],null],(n=>r(x(e,n),o+1)));return r(e,0),t})(e,t),(e=>y(e,(e=>x(o,e)[0](n,...null!=t?t:[],...r))))),e=>c(x(o,e),(([,n,t])=>(S(n,null!=t?t:[""],void 0,(n=>(p(n,e),L(n)?1:0))),I(o,e),r(e),t))),e=>c(x(o,e),(([e,,t=[],r,o])=>{const u=(...s)=>{var d,a;const c=i(s);c==i(t)?e(n,...s,...o(s)):v(t[c])?l(null!=(a=null==(d=r[c])?void 0:d.call(r,...s))?a:[],(e=>u(...s,e))):u(...s,t[c])};u()}))]})(),J={setMetricDefinition:(l,r,i,u,s,d,c)=>{var h;const f=e(i)==t?[i,s,d,c]:null!=(h=x(T,i))?h:x(T,"sum");return W(l,r,((e,n,t,r,i,u)=>{const s=F(l),d=g(r);u||(u=v(s)),e();let c=((e,n,t,l,r,i=!1)=>{if(L(t))return;const[o,u,s,d]=r;return i||(i=v(e)),y(l,(([t,l])=>{i||(e=v(t)?null==u?void 0:u(e,l,n++):v(l)?null==s?void 0:s(e,t,n--):null==d?void 0:d(e,l,t,n),i||(i=v(e)))})),i?o(m(t),g(t)):e})(s,d,r,n,f,u);a(c)||(c=void 0),c!=s&&(O(l,c),G(o,[l],c,s))}),(1,e(M=u)==n?e=>e(M):null!=M?M:()=>1)),J;var M},delMetricDefinition:e=>($(e),J),getStore:s,getMetricIds:d,forEachMetric:N,hasMetric:j,getTableId:C,getMetric:F,addMetricListener:(e,n)=>B(n,o,[e]),delListener:e=>(H(e),J),destroy:q,getListenerStats:()=>({})};return D(J)})(r)),o.get(r))})();export{N as createMetrics};
