import{watch as e,promises as t}from"fs";const n=e=>typeof e,l=n(""),o=n(!0),s=n(0),r=n(n),a=e=>""+e,i=(e,t)=>e.includes(t),d=(e,t)=>e.every(t),u=(e,t)=>L(e)===L(t)&&d(e,((e,n)=>t[n]===e)),c=(e,t)=>d(e,((n,l)=>0==l||t(e[l-1],n)<=0)),v=(e,t)=>e.sort(t),h=(e,t)=>e.forEach(t),f=(e,t)=>e.map(t),g=e=>w(e,((e,t)=>e+t),0),L=e=>e.length,y=e=>0==L(e),w=(e,t,n)=>e.reduce(t,n),p=(e,t,n)=>e.slice(t,n),I=(e,...t)=>e.push(...t),R=e=>e.pop(),S=e=>e.shift(),T=e=>JSON.stringify(e,((e,t)=>E(t,Map)?w([...t],((e,[t,n])=>(e[t]=n,e)),{}):t)),b=JSON.parse,m=Math.max,C=Math.min,V=isFinite,E=(e,t)=>e instanceof t,x=e=>null==e,k=(e,t,n)=>x(e)?null==n?void 0:n():t(e),J=e=>e==l||e==o,P=e=>n(e)==r,A=e=>Array.isArray(e),M=()=>{},D=e=>e.size,O=(e,t)=>{var n;return null!=(n=null==e?void 0:e.has(t))&&n},F=e=>x(e)||0==D(e),j=e=>{var t;return[...null!=(t=null==e?void 0:e.values())?t:[]]},Q=e=>e.clear(),z=(e,t)=>null==e?void 0:e.forEach(t),N=(e,t)=>null==e?void 0:e.delete(t),W=e=>new Map(e),B=e=>{var t;return[...null!=(t=null==e?void 0:e.keys())?t:[]]},H=(e,t)=>null==e?void 0:e.get(t),$=(e,t)=>z(e,((e,n)=>t(n,e))),q=(e,t,n)=>x(n)?(N(e,t),e):null==e?void 0:e.set(t,n),G=(e,t,n)=>(O(e,t)||q(e,t,n()),H(e,t)),K=(e,t,n)=>{const l={},o=null!=t?t:e=>e;return z(e,((e,t)=>k(o(e),(e=>(null==n?void 0:n(e))?0:l[t]=e)))),l},U=(e,t)=>{const n=W(),l=null!=t?t:e=>e;return z(e,((e,t)=>n.set(t,l(e)))),n},X=e=>U(e,U),Y=(e,t,n,l,o=0)=>k((n?G:H)(e,t[o],o>L(t)-2?n:W),(s=>{if(o>L(t)-2)return(null==l?void 0:l(s))&&q(e,t[o]),s;const r=Y(s,t,n,l,o+1);return F(s)&&q(e,t[o]),r})),Z=e=>{const t=n(e);return J(t)||t==s&&V(e)?t:void 0},_=(e,t,n,l,o)=>x(o)?e.delCell(t,n,l,!0):e.setCell(t,n,l,o),ee=(e,t,n)=>x(n)?e.delValue(t):e.setValue(t,n),te=e=>new Set(A(e)||x(e)?e:[e]),ne=(e,t)=>null==e?void 0:e.add(t),le=(e,t,n)=>{const l=e.hasRow,o=W(),s=W(),r=W(),a=W(),i=W(),d=(t,n,...l)=>{const o=G(i,t,te);return h(l,(t=>ne(o,t)&&n&&e.callListener(t))),l},c=(t,...n)=>k(H(i,t),(l=>{h(y(n)?j(l):n,(t=>{e.delListener(t),N(l,t)})),F(l)&&q(i,t)})),v=(e,n)=>{q(o,e,n),O(s,e)||(q(s,e,t()),q(r,e,W()),q(a,e,W()))},f=e=>{q(o,e),q(s,e),q(r,e),q(a,e),c(e)};return[()=>e,()=>B(o),e=>$(s,e),e=>O(s,e),e=>H(o,e),e=>H(s,e),(e,t)=>q(s,e,t),v,(t,o,s,i,f)=>{v(t,o);const g=W(),L=W(),y=H(r,t),w=H(a,t),p=t=>{const s=n=>e.getCell(o,t,n),r=H(y,t),a=l(o,t)?n(i(s,t)):void 0;if(r===a||A(r)&&A(a)&&u(r,a)||q(g,t,[r,a]),!x(f)){const e=H(w,t),n=l(o,t)?f(s,t):void 0;e!=n&&q(L,t,n)}},I=e=>{s((()=>{z(g,(([,e],t)=>q(y,t,e))),z(L,((e,t)=>q(w,t,e)))}),g,L,y,w,e),Q(g),Q(L)};$(y,p),e.hasTable(o)&&h(e.getRowIds(o),(e=>{O(y,e)||p(e)})),I(!0),c(t),d(t,0,e.addRowListener(o,null,((e,t,n)=>p(n))),e.addTableListener(o,(()=>I())))},f,()=>$(i,f),d,c]},oe=(e,t)=>n(e)==l?t=>t(e):null!=e?e:()=>null!=t?t:"",se=e=>{const t=new WeakMap;return n=>(t.has(n)||t.set(n,e(n)),t.get(n))},re=/^\d+$/,ae=()=>{const e=[];let t=0;return[()=>{var n;return null!=(n=S(e))?n:""+t++},t=>{re.test(t)&&L(e)<1e3&&I(e,t)}]},ie=e=>{let t;const[n,l]=ae(),o=W();return[(l,s,r,a=[],i=(()=>[]))=>{null!=t||(t=e());const d=n();return q(o,d,[l,s,r,a,i]),ne(Y(s,null!=r?r:[""],te),d),d},(e,n,...l)=>h(((e,t=[""])=>{const n=[],l=(e,o)=>o==L(t)?I(n,e):null===t[o]?z(e,(e=>l(e,o+1))):h([t[o],null],(t=>l(H(e,t),o+1)));return l(e,0),n})(e,n),(e=>z(e,(e=>H(o,e)[0](t,...null!=n?n:[],...l))))),e=>k(H(o,e),(([,t,n])=>(Y(t,null!=n?n:[""],void 0,(t=>(N(t,e),F(t)?1:0))),q(o,e),l(e),n))),e=>k(H(o,e),(([e,,n=[],l,o])=>{const s=(...r)=>{var a,i;const d=L(r);d==L(n)?e(t,...r,...o(r)):x(n[d])?h(null!=(i=null==(a=l[d])?void 0:a.call(l,...r))?i:[],(e=>s(...r,e))):s(...r,n[d])};s()}))]},de=Object,ue=de.keys,ce=de.isFrozen,ve=de.freeze,he=e=>E(e,de)&&e.constructor==de,fe=(e,t)=>!x(((e,t)=>k(e,(e=>e[t])))(e,t)),ge=(e,t)=>delete e[t],Le=(e,t)=>f(de.entries(e),(([e,n])=>t(n,e))),ye=e=>he(e)&&y(ue(e)),we=se((e=>{let t,n,l,o=100,s=W(),r=W(),a=1;const d=W(),u=W(),[c,v,f]=ie((()=>U)),g=W(),w=W(),p=[],T=[],b=(t,n)=>{a=0,e.transaction((()=>{const[l,o]=H(g,n);z(l,((n,l)=>z(n,((n,o)=>z(n,((n,s)=>_(e,l,o,s,n[t]))))))),z(o,((n,l)=>ee(e,l,n[t])))})),a=1},m=e=>{q(g,e),q(w,e),v(u,[e])},C=(e,t)=>h(((e,t)=>e.splice(0,t))(e,null!=t?t:L(e)),m),V=()=>C(p,L(p)-o),E=()=>k(t,(()=>{I(p,t),V(),C(T),t=void 0,l=1})),J=()=>{t=R(p),l=1},P=e.addCellListener(null,null,null,((e,t,n,l,o,r)=>{if(a){E();const e=G(s,t,W),a=G(e,n,W),i=G(a,l,(()=>[r,void 0]));i[1]=o,i[0]===o&&F(q(a,l))&&F(q(e,n))&&F(q(s,t))&&J(),Q()}})),A=e.addValueListener(null,((e,t,n,l)=>{if(a){E();const e=G(r,t,(()=>[l,void 0]));e[1]=n,e[0]===n&&F(q(r,t))&&J(),Q()}})),M=(e="")=>(x(t)&&(t=""+n++,q(g,t,[s,r]),B(t,e),s=W(),r=W(),l=1),t),D=()=>{y(p)||(((e,...t)=>{e.unshift(...t)})(T,M()),b(0,t),t=R(p),l=1)},j=()=>{y(T)||(I(p,t),t=S(T),b(1,t),l=1)},Q=()=>{l&&(v(d),l=0)},N=e=>{const t=M(e);return Q(),t},B=(e,t)=>(K(e)&&H(w,e)!==t&&(q(w,e,t),v(u,[e])),U),K=e=>O(g,e),U={setSize:e=>(o=e,V(),U),addCheckpoint:N,setCheckpoint:B,getStore:()=>e,getCheckpointIds:()=>[[...p],t,[...T]],forEachCheckpoint:e=>$(w,e),hasCheckpoint:K,getCheckpoint:e=>H(w,e),goBackward:()=>(D(),Q(),U),goForward:()=>(j(),Q(),U),goTo:e=>{const n=i(p,e)?D:i(T,e)?j:null;for(;!x(n)&&e!=t;)n();return Q(),U},addCheckpointIdsListener:e=>c(e,d),addCheckpointListener:(e,t)=>c(t,u,[e]),delListener:e=>(f(e),U),clear:()=>(C(p),C(T),x(t)||m(t),t=void 0,n=0,N(),U),destroy:()=>{e.delListener(P),e.delListener(A)},getListenerStats:()=>({})};return ve(U.clear())})),pe=(e,t)=>e<t?-1:1,Ie=se((e=>{const t=W(),n=W(),[l,o,s,r,i,d,u,,h,g,L]=le(e,W,(e=>x(e)?"":A(e)?f(e,a):a(e))),[y,w,p]=ie((()=>R)),I=(t,n,l)=>{const o=i(t);z(l,((t,l)=>n(l,(n=>z(t,(t=>n(t,(n=>e.forEachCell(o,t,n)))))))))},R={setIndexDefinition:(e,l,o,s,r,a=pe)=>{const i=x(r)?void 0:([e],[t])=>r(e,t);return h(e,l,((l,o,r,h,f,g)=>{let L=0;const y=te(),p=te(),I=d(e);if(z(o,(([e,t],n)=>{const l=te(e),o=te(t);z(l,(e=>N(o,e)?N(l,e):0)),z(l,(e=>{ne(y,e),k(H(I,e),(t=>{N(t,n),F(t)&&(q(I,e),L=1)}))})),z(o,(e=>{ne(y,e),O(I,e)||(q(I,e,te()),L=1),ne(H(I,e),n),x(s)||ne(p,e)}))})),l(),F(f)||(g?$(I,(e=>ne(p,e))):$(r,(e=>k(H(h,e),(e=>ne(p,e))))),z(p,(e=>{const t=(t,n)=>a(H(f,t),H(f,n),e),n=[...H(I,e)];c(n,t)||(q(I,e,te(v(n,t))),ne(y,e))}))),(L||g)&&!x(i)){const t=[...I];c(t,i)||(u(e,W(v(t,i))),L=1)}L&&w(t,[e]),z(y,(t=>w(n,[e,t])))}),oe(o),k(s,oe)),R},delIndexDefinition:e=>(g(e),R),getStore:l,getIndexIds:o,forEachIndex:e=>s(((t,n)=>e(t,(e=>I(t,e,n))))),forEachSlice:(e,t)=>I(e,t,d(e)),hasIndex:r,hasSlice:(e,t)=>O(d(e),t),getTableId:i,getSliceIds:e=>B(d(e)),getSliceRowIds:(e,t)=>j(H(d(e),t)),addSliceIdsListener:(e,n)=>y(n,t,[e]),addSliceRowIdsListener:(e,t,l)=>y(l,n,[e,t]),delListener:e=>(p(e),R),destroy:L,getListenerStats:()=>({})};return ve(R)})),Re=W([["avg",[(e,t)=>g(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,l)=>e+(t-n)/l]],["max",[e=>m(...e),(e,t)=>m(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:m(t,e)]],["min",[e=>C(...e),(e,t)=>C(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:C(t,e)]],["sum",[e=>g(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),Se=(e,t,n,l,o,s=!1)=>{if(F(n))return;const[r,a,i,d]=o;return s||(s=x(e)),z(l,(([n,l])=>{s||(e=x(n)?null==a?void 0:a(e,l,t++):x(l)?null==i?void 0:i(e,n,t--):null==d?void 0:d(e,l,n,t),s||(s=x(e)))})),s?r(j(n),D(n)):e},Te=se((e=>{const t=W(),[n,l,o,s,r,a,i,,d,u,c]=le(e,M,(e=>isNaN(e)||x(e)||!0===e||!1===e||""===e?void 0:1*e)),[v,h,f]=ie((()=>g)),g={setMetricDefinition:(e,n,l,o,s,r,u)=>{var c;const v=P(l)?[l,s,r,u]:null!=(c=H(Re,l))?c:H(Re,"sum");return d(e,n,((n,l,o,s,r,d)=>{const u=a(e),c=D(s);d||(d=x(u)),n();let f=Se(u,c,s,l,v,d);V(f)||(f=void 0),f!=u&&(i(e,f),h(t,[e],f,u))}),oe(o,1)),g},delMetricDefinition:e=>(u(e),g),getStore:n,getMetricIds:l,forEachMetric:o,hasMetric:s,getTableId:r,getMetric:a,addMetricListener:(e,n)=>v(n,t,[e]),delListener:e=>(f(e),g),destroy:c,getListenerStats:()=>({})};return ve(g)}));var be=(e,t,n)=>new Promise(((l,o)=>{var s=e=>{try{a(n.next(e))}catch(e){o(e)}},r=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(s,r);a((n=n.apply(e,t)).next())}));const me=(e,t,n,l,o)=>{let s,r,a=0;const i={load:(n,l)=>be(void 0,null,(function*(){if(2!=a){a=1;const o=yield t();x(o)||""==o?e.transaction((()=>e.setTables(n).setValues(l))):e.setJson(o),a=0}return i})),startAutoLoad:(e,t)=>be(void 0,null,(function*(){return i.stopAutoLoad(),yield i.load(e,t),l(i.load),i})),stopAutoLoad:()=>(o(),i),save:()=>be(void 0,null,(function*(){return 1!=a&&(a=2,yield n(e.getJson()),a=0),i})),startAutoSave:()=>be(void 0,null,(function*(){return yield i.stopAutoSave().save(),s=e.addTablesListener(i.save),r=e.addValuesListener(i.save),i})),stopAutoSave:()=>(k(s,e.delListener),k(r,e.delListener),i),getStore:()=>e,destroy:()=>i.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return ve(i)};var Ce=(e,t,n)=>new Promise(((l,o)=>{var s=e=>{try{a(n.next(e))}catch(e){o(e)}},r=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(s,r);a((n=n.apply(e,t)).next())}));const Ve=globalThis.window,Ee=(e,t,n)=>{let l;return me(e,(()=>Ce(void 0,null,(function*(){return n.getItem(t)}))),(e=>Ce(void 0,null,(function*(){return n.setItem(t,e)}))),(e=>{l=l=>{l.storageArea===n&&l.key===t&&e()},Ve.addEventListener("storage",l)}),(()=>{Ve.removeEventListener("storage",l),l=void 0}))},xe=(e,t)=>Ee(e,t,localStorage),ke=(e,t)=>Ee(e,t,sessionStorage);var Je=(e,t,n)=>new Promise(((l,o)=>{var s=e=>{try{a(n.next(e))}catch(e){o(e)}},r=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(s,r);a((n=n.apply(e,t)).next())}));const Pe=(n,l)=>{let o;return me(n,(()=>Je(void 0,null,(function*(){try{return yield t.readFile(l,"utf8")}catch(e){}}))),(e=>Je(void 0,null,(function*(){try{yield t.writeFile(l,e,"utf8")}catch(e){}}))),(t=>{o=e(l,t)}),(()=>{null==o||o.close(),o=void 0}))};var Ae=(e,t,n)=>new Promise(((l,o)=>{var s=e=>{try{a(n.next(e))}catch(e){o(e)}},r=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(s,r);a((n=n.apply(e,t)).next())}));const Me=e=>e.headers.get("ETag"),De=(e,t,n,l)=>{let o,s;return me(e,(()=>Ae(void 0,null,(function*(){const e=yield fetch(t);return s=Me(e),e.text()}))),(e=>Ae(void 0,null,(function*(){return yield fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:e})}))),(e=>{o=setInterval((()=>Ae(void 0,null,(function*(){const n=yield fetch(t,{method:"HEAD"}),l=Me(n);x(s)||x(l)||l==s||(s=l,e())}))),1e3*l)}),(()=>{k(o,clearInterval),o=void 0}))};var Oe=Object.getOwnPropertySymbols,Fe=Object.prototype.hasOwnProperty,je=Object.prototype.propertyIsEnumerable;const Qe=se((e=>{const t=e.createStore,[n,l,o,s,r,,,a,,i,u,c,v]=le(e,(()=>!0),M),f=t(),g=t(),w=W(),R=(e,t,...n)=>h(n,(n=>ne(G(G(w,t,W),e,te),n))),S=e=>{k(H(w,e),(e=>{$(e,((e,t)=>z(t,(t=>e.delListener(t))))),Q(e)})),h([g,f],(t=>t.delTable(e)))},T=(e,t,n)=>R(t,e,t.addWillFinishTransactionListener(n.startTransaction),t.addDidFinishTransactionListener((()=>n.finishTransaction()))),b={setQueryDefinition:(t,n,l)=>{a(t,n),S(t);const o=[],s=[[null,[n,null,null,[],W()]]],r=[],i=[],u=[];l({select:(e,t)=>{const n=P(e)?[L(o)+"",e]:[x(t)?e:t,n=>n(e,t)];return I(o,n),{as:e=>n[0]=e}},join:(e,t,n)=>{const l=x(n)||P(t)?null:t,o=x(l)?t:n,r=[e,[e,l,P(o)?o:e=>e(o),[],W()]];return I(s,r),{as:e=>r[0]=e}},where:(e,t,n)=>I(r,P(e)?e:x(n)?n=>n(e)===t:l=>l(e,t)===n),group:(e,t,n,l,o)=>{var s;const r=[e,[e,P(t)?[t,n,l,o]:null!=(s=H(Re,t))?s:[(e,t)=>t]]];return I(i,r),{as:e=>r[0]=e}},having:(e,t)=>I(u,P(e)?e:n=>n(e)===t)});const w=W(o);if(F(w))return b;const p=W(s);$(p,((e,[,t])=>k(H(p,t),(({3:t})=>x(e)?0:I(t,e)))));const m=W(i);let C=f;if(F(m)&&y(u))C=g;else{T(t,C,g);const e=W();$(m,((t,[n,l])=>ne(G(e,n,te),[t,l])));const n=te();$(w,(t=>O(e,t)?0:ne(n,t)));const l=W(),o=(n,l,o,s)=>k(n,(([r,a,i,c])=>{$(l,((t,[n])=>{const l=G(r,t,W),a=H(l,o),i=s?void 0:n;if(a!==i){const n=te([[a,i]]),s=D(l);q(l,o,i),z(H(e,t),(([e,t])=>{const o=Se(c[e],s,l,n,t);c[e]=x(Z(o))?null:o}))}})),F(a)||!d(u,(e=>e((e=>c[e]))))?g.delRow(t,i):x(i)?n[2]=g.addRow(t,c):g.setRow(t,i,c)}));R(C,t,C.addRowListener(t,null,((s,r,a,i)=>{const d=[],u=[],c=W(),v=C.hasRow(t,a);let h=!v;z(n,(e=>{const[n,l,o]=i(t,a,e);I(d,l),I(u,o),h||(h=n)})),$(e,(e=>{const[n,,l]=i(t,a,e);(h||n)&&q(c,e,[l])})),h&&o(Y(l,d,void 0,(([,e])=>(N(e,a),F(e)))),c,a,1),v&&o(Y(l,u,(()=>{const e={};return z(n,(n=>e[n]=C.getCell(t,a,n))),[W(),te(),void 0,e]}),(([,e])=>{ne(e,a)})),c,a)})))}T(t,e,C);const V=(l,o,s,a)=>{const i=t=>e.getCell(o,s,t);h(a,(n=>{var o;const[s,,r,a,d]=H(p,n),u=null==r?void 0:r(i,l),[h,f]=null!=(o=H(d,l))?o:[];u!=h&&(x(f)||v(t,f),q(d,l,x(u)?null:[u,...c(t,1,e.addRowListener(s,u,(()=>V(l,s,u,a))))]))})),(l=>{const o=(t,o)=>{var s,r,a;return e.getCell(...x(o)?[n,l,t]:t===n?[n,l,o]:[null==(s=H(p,t))?void 0:s[0],null==(a=H(null==(r=H(p,t))?void 0:r[4],l))?void 0:a[0],o])};C.transaction((()=>d(r,(e=>e(o)))?$(w,((e,n)=>_(C,t,l,e,n(o,l)))):C.delRow(t,l)))})(l)},{3:E}=H(p,null);return C.transaction((()=>c(t,1,e.addRowListener(n,null,((l,o,s)=>{e.hasRow(n,s)?V(s,n,s,E):(C.delRow(t,s),z(p,(({4:e})=>k(H(e,s),(([,n])=>{v(t,n),q(e,s)})))))}))))),b},delQueryDefinition:e=>(S(e),i(e),b),getStore:n,getQueryIds:l,forEachQuery:o,hasQuery:s,getTableId:r,delListener:e=>(g.delListener(e),b),destroy:u,getListenerStats:()=>((e,t)=>{var n={};for(var l in e)Fe.call(e,l)&&t.indexOf(l)<0&&(n[l]=e[l]);if(null!=e&&Oe)for(var l of Oe(e))t.indexOf(l)<0&&je.call(e,l)&&(n[l]=e[l]);return n})(g.getListenerStats(),["tables","tableIds","transaction"])};return Le({Table:[1,1],RowIds:[0,1],SortedRowIds:[0,5],Row:[1,2],CellIds:[0,2],Cell:[1,3]},(([e,t],n)=>{h(e?["get","has","forEach"]:["get"],(e=>b[e+"Result"+n]=(...t)=>g[e+n](...t))),b["addResult"+n+"Listener"]=(...e)=>g["add"+n+"Listener"](...p(e,0,t),((n,...l)=>e[t](b,...l)))})),ve(b)})),ze=se((e=>{const t=W(),n=W(),l=W(),o=W(),[s,r,a,i,d,u,,,c,v,h]=le(e,(()=>[W(),W(),W(),W()]),(e=>x(e)?void 0:e+"")),[f,g,L]=ie((()=>I)),y=(e,t,n)=>k(u(e),(([l,,o])=>{if(!O(o,t)){const s=te();if(d(e)!=p(e))ne(s,t);else{let e=t;for(;!x(e)&&!O(s,e);)ne(s,e),e=H(l,e)}if(n)return s;q(o,t,s)}return H(o,t)})),w=(e,t)=>k(u(e),(([,,e])=>q(e,t))),p=e=>H(t,e),I={setRelationshipDefinition:(e,s,r,a)=>(q(t,e,r),c(e,s,((t,s)=>{const r=te(),a=te(),i=te(),[d,c]=u(e);z(s,(([t,n],l)=>{x(t)||(ne(a,t),k(H(c,t),(e=>{N(e,l),F(e)&&q(c,t)}))),x(n)||(ne(a,n),O(c,n)||q(c,n,te()),ne(H(c,n),l)),ne(r,l),q(d,l,n),$(H(o,e),(t=>{O(y(e,t),l)&&ne(i,t)}))})),t(),z(r,(t=>g(n,[e,t]))),z(a,(t=>g(l,[e,t]))),z(i,(t=>{w(e,t),g(o,[e,t])}))}),oe(a)),I),delRelationshipDefinition:e=>(q(t,e),v(e),I),getStore:s,getRelationshipIds:r,forEachRelationship:t=>a((n=>t(n,(t=>e.forEachRow(d(n),t))))),hasRelationship:i,getLocalTableId:d,getRemoteTableId:p,getRemoteRowId:(e,t)=>{var n;return H(null==(n=u(e))?void 0:n[0],t)},getLocalRowIds:(e,t)=>{var n;return j(H(null==(n=u(e))?void 0:n[1],t))},getLinkedRowIds:(e,t)=>x(u(e))?[t]:j(y(e,t,!0)),addRemoteRowIdListener:(e,t,l)=>f(l,n,[e,t]),addLocalRowIdsListener:(e,t,n)=>f(n,l,[e,t]),addLinkedRowIdsListener:(e,t,n)=>(y(e,t),f(n,o,[e,t])),delListener:e=>(w(...L(e)),I),destroy:h,getListenerStats:()=>({})};return ve(I)})),Ne=e=>[e,e],We=()=>[W(),W()],Be=(e,t,n,l=q)=>{const o=(s=e=>!fe(t,e),B(e).filter(s));var s;return h(ue(t),(l=>n(e,l,t[l]))),h(o,(t=>l(e,t))),e},He=(e,t,n)=>x(e)||!he(e)||ye(e)||ce(e)?(null==n||n(),!1):(Le(e,((n,l)=>{t(n,l)||ge(e,l)})),!ye(e)),$e=(e,t,n)=>q(e,t,H(e,t)==-n?void 0:n),qe=()=>{let e,t,n,l,o=0;const r=W(),d=W(),c=W(),g=W(),L=W(),y=W(),w=W(),R=W(),S=W(),m=W(),C=W(),V=W(),E=te(),A=W(),M=W(),D=W(),j=We(),Y=We(),le=We(),oe=We(),se=We(),re=We(),de=We(),ue=We(),ce=We(),he=We(),we=We(),Ie=We(),Re=We(),Se=We(),[Te,be,me,Ce]=ie((()=>Nt)),Ve=e=>{if(!He(e,((e,t)=>i(["type","default"],t))))return!1;const t=e.type;return!(!J(t)&&t!=s||(Z(e.default)!=t&&ge(e,"default"),0))},Ee=(t,n)=>(!e||O(S,n)||ut(n))&&He(t,((e,t)=>xe(n,t,e)),(()=>ut(n))),xe=(e,t,n,l)=>He(l?n:Ae(n,e,t),((l,o)=>k(ke(e,t,o,l),(e=>(n[o]=e,!0)),(()=>!1))),(()=>ut(e,t))),ke=(t,n,l,o)=>e?k(H(H(S,t),l),(e=>Z(o)!=e.type?ut(t,n,l,o,e.default):o),(()=>ut(t,n,l,o))):x(Z(o))?ut(t,n,l,o):o,Je=(e,t)=>He(t?e:Me(e),((t,n)=>k(Pe(n,t),(t=>(e[n]=t,!0)),(()=>!1))),(()=>ct())),Pe=(e,n)=>t?k(H(C,e),(t=>Z(n)!=t.type?ct(e,n,t.default):n),(()=>ct(e,n))):x(Z(n))?ct(e,n):n,Ae=(e,t,n)=>(k(H(m,t),(([l,o])=>{z(l,((t,n)=>{fe(e,n)||(e[n]=t)})),z(o,(l=>{fe(e,l)||ut(t,n,l)}))})),e),Me=e=>(t&&(z(V,((t,n)=>{fe(e,n)||(e[n]=t)})),z(E,(t=>{fe(e,t)||ct(t)}))),e),De=e=>Be(S,e,((e,t,n)=>{const l=W(),o=te();Be(G(S,t,W),n,((e,t,n)=>{q(e,t,n),k(n.default,(e=>q(l,t,e)),(()=>ne(o,t)))})),q(m,t,[l,o])}),((e,t)=>{q(S,t),q(m,t)})),Oe=e=>Be(C,e,((e,t,n)=>{q(C,t,n),k(n.default,(e=>q(V,t,e)),(()=>ne(E,t)))}),((e,t)=>{q(C,t),q(V,t),N(E,t)})),Fe=e=>ye(e)?Mt():xt(e),je=e=>Be(M,e,((e,t,n)=>Qe(t,n)),((e,t)=>et(t))),Qe=(e,t)=>Be(G(M,e,(()=>(ot(e,1),W()))),t,((t,n,l)=>ze(e,t,n,l)),((t,n)=>tt(e,t,n))),ze=(e,t,n,l,o)=>Be(G(t,n,(()=>(st(e,n,1),W()))),l,((t,l,o)=>Ge(e,n,t,l,o)),((l,s)=>nt(e,t,n,l,s,o))),Ge=(e,t,n,l,o)=>{O(n,l)||rt(e,t,l,1);const s=H(n,l);o!==s&&(at(e,t,l,s,o),q(n,l,o))},Ke=(e,t,n,l,o)=>k(H(t,n),(t=>Ge(e,n,t,l,o)),(()=>ze(e,t,n,Ae({[l]:o},e,n)))),Ue=e=>ye(e)?Dt():kt(e),Xe=e=>Be(D,e,((e,t,n)=>Ye(t,n)),((e,t)=>lt(t))),Ye=(e,t)=>{O(D,e)||it(e,1);const n=H(D,e);t!==n&&(dt(e,n,t),q(D,e,t))},Ze=e=>{const[t]=G(A,e,ae),n=t();return O(H(M,e),n)?Ze(e):n},_e=e=>{var t;return null!=(t=H(M,e))?t:Qe(e,{})},et=e=>Qe(e,{}),tt=(e,t,n)=>{const[,l]=G(A,e,ae);l(n),ze(e,t,n,{},!0)},nt=(e,t,n,l,o,s)=>{var r;const a=H(null==(r=H(m,e))?void 0:r[0],o);if(!x(a)&&!s)return Ge(e,n,l,o,a);const i=t=>{at(e,n,t,H(l,t)),rt(e,n,t,-1),q(l,t)};x(a)?i(o):$(l,i),F(l)&&(st(e,n,-1),F(q(t,n))&&(ot(e,-1),q(M,e),q(A,e)))},lt=e=>{const t=H(V,e);if(!x(t))return Ye(e,t);dt(e,H(D,e)),it(e,-1),q(D,e)},ot=(e,t)=>$e(r,e,t),st=(e,t,n)=>$e(G(d,e,W),t,n),rt=(e,t,n,l)=>$e(G(G(c,e,W),t,W),n,l),at=(e,t,n,l,o)=>G(G(G(g,e,W),t,W),n,(()=>[l,0]))[1]=o,it=(e,t)=>$e(L,e,t),dt=(e,t,n)=>G(y,e,(()=>[t,0]))[1]=n,ut=(e,t,n,l,o)=>(I(G(G(G(w,e,W),t,W),n,(()=>[])),l),o),ct=(e,t,n)=>(I(G(R,e,(()=>[])),t),n),vt=(e,t,n)=>k(H(H(H(g,e),t),n),(([e,t])=>[!0,e,t]),(()=>[!1,...Ne(mt(e,t,n))])),ht=e=>k(H(y,e),(([e,t])=>[!0,e,t]),(()=>[!1,...Ne(Et(e))])),ft=e=>F(w)||F(ce[e])?0:z(e?U(w,X):w,((t,n)=>z(t,((t,l)=>z(t,((t,o)=>be(ce[e],[n,l,o],t))))))),gt=e=>F(R)||F(he[e])?0:z(e?U(R):R,((t,n)=>be(he[e],[n],t))),Lt=(e,t,n)=>{if(!F(t))return be(e,n),1},yt=e=>{const t=F(se[e]),n=F(de[e])&&F(oe[e])&&t&&F(Y[e]),l=F(ue[e])&&F(re[e])&&F(le[e])&&F(j[e]);if(!n||!l){const o=e?[U(r),X(d),U(c,X),U(g,X)]:[r,d,c,g];if(!n){z(o[2],((t,n)=>z(t,((t,l)=>Lt(de[e],t,[n,l])))));const n=te();z(o[1],((l,o)=>{Lt(oe[e],l,[o])&&!t&&(be(se[e],[o,null]),ne(n,o))})),t||z(o[3],((t,l)=>{if(!O(n,l)){const n=te();z(t,(e=>z(e,(([t,l],o)=>l!==t?ne(n,o):N(e,o))))),z(n,(t=>be(se[e],[l,t])))}})),Lt(Y[e],o[0])}if(!l){let t;z(o[3],((n,l)=>{let o;z(n,((n,s)=>{let r;z(n,(([n,a],i)=>{a!==n&&(be(ue[e],[l,s,i],a,n,vt),t=o=r=1)})),r&&be(re[e],[l,s],vt)})),o&&be(le[e],[l],vt)})),t&&be(j[e],void 0,vt)}}},wt=e=>{const t=F(Ie[e]),n=F(Re[e])&&F(we[e]);if(!t||!n){const l=e?[U(L),U(y)]:[L,y];if(t||Lt(Ie[e],l[0]),!n){let t;z(l[1],(([n,l],o)=>{l!==n&&(be(Re[e],[o],l,n,ht),t=1)})),t&&be(we[e],void 0,ht)}}},pt=(e,...t)=>(jt((()=>e(...f(t,a)))),Nt),It=()=>K(M,(e=>K(e,K))),Rt=()=>B(M),St=e=>B(H(M,a(e))),Tt=(e,t,n,l=0,o)=>{return f(p(v((s=H(M,a(e)),r=(e,n)=>[x(t)?n:H(e,a(t)),n],f([...null!=(i=null==s?void 0:s.entries())?i:[]],(([e,t])=>r(t,e)))),(([e],[t])=>pe(e,t)*(n?-1:1))),l,x(o)?o:l+o),(([,e])=>e));var s,r,i},bt=(e,t)=>B(H(H(M,a(e)),a(t))),mt=(e,t,n)=>H(H(H(M,a(e)),a(t)),a(n)),Ct=()=>K(D),Vt=()=>B(D),Et=e=>H(D,a(e)),xt=e=>pt((()=>(e=>He(e,Ee,ut))(e)?je(e):0)),kt=e=>pt((()=>Je(e)?Xe(e):0)),Jt=e=>{try{Fe(b(e))}catch(e){}return Nt},Pt=t=>pt((()=>{if((e=He(t,(e=>He(e,Ve))))&&(De(t),!F(M))){const e=It();Mt(),xt(e)}})),At=e=>pt((()=>{if(t=(e=>He(e,Ve))(e)){const n=Ct();Ft(),Dt(),t=!0,Oe(e),kt(n)}})),Mt=()=>pt((()=>je({}))),Dt=()=>pt((()=>Xe({}))),Ot=()=>pt((()=>{De({}),e=!1})),Ft=()=>pt((()=>{Oe({}),t=!1})),jt=(e,t)=>{if(-1==o)return;Qt();const n=e();return zt(t),n},Qt=()=>(o++,Nt),zt=e=>(o>0&&(o--,0==o&&(n=!F(g),l=!F(y),o=1,ft(1),n&&yt(1),gt(1),l&&wt(1),o=-1,(null==e?void 0:e(K(g,(e=>K(e,(e=>K(e,(e=>[...e]),(([e,t])=>e===t))),ye)),ye),K(w,(e=>K(e,K))),K(y,(e=>[...e]),(([e,t])=>e===t)),K(R)))&&(o=1,z(g,((e,t)=>z(e,((e,n)=>z(e,(([e],l)=>_(Nt,t,n,l,e))))))),z(y,(([e],t)=>ee(Nt,t,e))),o=-1,n=l=!1),be(Se[0],void 0,n,l),ft(0),n&&yt(0),gt(0),l&&wt(0),be(Se[1],void 0,n,l),o=0,h([r,d,c,g,w,L,y,R],Q))),Nt),Nt={getTables:It,getTableIds:Rt,getTable:e=>K(H(M,a(e)),K),getRowIds:St,getSortedRowIds:Tt,getRow:(e,t)=>K(H(H(M,a(e)),a(t))),getCellIds:bt,getCell:mt,getValues:Ct,getValueIds:Vt,getValue:Et,hasTables:()=>!F(M),hasTable:e=>O(M,a(e)),hasRow:(e,t)=>O(H(M,a(e)),a(t)),hasCell:(e,t,n)=>O(H(H(M,a(e)),a(t)),a(n)),hasValues:()=>!F(D),hasValue:e=>O(D,a(e)),getTablesJson:()=>T(M),getValuesJson:()=>T(D),getJson:()=>T([M,D]),getTablesSchemaJson:()=>T(S),getValuesSchemaJson:()=>T(C),getSchemaJson:()=>T([S,C]),setTables:xt,setTable:(e,t)=>pt((e=>Ee(t,e)?Qe(e,t):0),e),setRow:(e,t,n)=>pt(((e,t)=>xe(e,t,n)?ze(e,_e(e),t,n):0),e,t),addRow:(e,t)=>jt((()=>{let n;return xe(e,n,t)&&(e=a(e),ze(e,_e(e),n=Ze(e),t)),n})),setPartialRow:(e,t,n)=>pt(((e,t)=>{if(xe(e,t,n,1)){const l=_e(e);Le(n,((n,o)=>Ke(e,l,t,o,n)))}}),e,t),setCell:(e,t,n,l)=>pt(((e,t,n)=>k(ke(e,t,n,P(l)?l(mt(e,t,n)):l),(l=>Ke(e,_e(e),t,n,l)))),e,t,n),setValues:kt,setPartialValues:e=>pt((()=>Je(e,1)?Le(e,((e,t)=>Ye(t,e))):0)),setValue:(e,t)=>pt((e=>k(Pe(e,P(t)?t(Et(e)):t),(t=>Ye(e,t)))),e),setTablesJson:Jt,setValuesJson:e=>{try{Ue(b(e))}catch(e){}return Nt},setJson:e=>{try{const[t,n]=b(e);Fe(t),Ue(n)}catch(t){Jt(e)}return Nt},setTablesSchema:Pt,setValuesSchema:At,setSchema:(e,t)=>pt((()=>{Pt(e),At(t)})),delTables:Mt,delTable:e=>pt((e=>O(M,e)?et(e):0),e),delRow:(e,t)=>pt(((e,t)=>k(H(M,e),(n=>O(n,t)?tt(e,n,t):0))),e,t),delCell:(e,t,n,l)=>pt(((e,t,n)=>k(H(M,e),(o=>k(H(o,t),(s=>O(s,n)?nt(e,o,t,s,n,l):0))))),e,t,n),delValues:Dt,delValue:e=>pt((e=>O(D,e)?lt(e):0),e),delTablesSchema:Ot,delValuesSchema:Ft,delSchema:()=>pt((()=>{Ot(),Ft()})),transaction:jt,startTransaction:Qt,finishTransaction:zt,forEachTable:e=>z(M,((t,n)=>e(n,(e=>z(t,((t,n)=>e(n,(e=>$(t,e))))))))),forEachRow:(e,t)=>z(H(M,a(e)),((e,n)=>t(n,(t=>$(e,t))))),forEachCell:(e,t,n)=>$(H(H(M,a(e)),a(t)),n),forEachValue:e=>$(D,e),addSortedRowIdsListener:(e,t,n,l,o,s,r)=>{let a=Tt(e,t,n,l,o);return Te((()=>{const r=Tt(e,t,n,l,o);u(r,a)||(a=r,s(Nt,e,t,n,l,o,a))}),se[r?1:0],[e,t],[Rt])},addWillFinishTransactionListener:e=>Te(e,Se[0]),addDidFinishTransactionListener:e=>Te(e,Se[1]),callListener:e=>(Ce(e),Nt),delListener:e=>(me(e),Nt),getListenerStats:()=>({}),createStore:qe};return Le({Tables:[0,j],TableIds:[0,Y],Table:[1,le,[Rt]],RowIds:[1,oe,[Rt]],Row:[2,re,[Rt,St]],CellIds:[2,de,[Rt,St]],Cell:[3,ue,[Rt,St,bt],e=>Ne(mt(...e))],InvalidCell:[3,ce],Values:[0,we],ValueIds:[0,Ie],Value:[1,Re,[Vt],e=>Ne(Et(e[0]))],InvalidValue:[1,he]},(([e,t,n,l],o)=>{Nt["add"+o+"Listener"]=(...o)=>Te(o[e],t[o[e+1]?1:0],e>0?p(o,0,e):void 0,n,l)})),ve(Nt)};export{we as createCheckpoints,me as createCustomPersister,Pe as createFilePersister,Ie as createIndexes,xe as createLocalPersister,Te as createMetrics,Qe as createQueries,ze as createRelationships,De as createRemotePersister,ke as createSessionPersister,qe as createStore,pe as defaultSorter};
