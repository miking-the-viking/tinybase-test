import{watch as e,promises as t}from"fs";const o=e=>null==e,n=(e,t,n)=>o(e)?null==n?void 0:n():t(e),r=Object.freeze;var l=(e,t,o)=>new Promise(((n,r)=>{var l=e=>{try{s(o.next(e))}catch(e){r(e)}},a=e=>{try{s(o.throw(e))}catch(e){r(e)}},s=e=>e.done?n(e.value):Promise.resolve(e.value).then(l,a);s((o=o.apply(e,t)).next())}));const a=(e,t,a,s,i)=>{let u,d,c=0;const v={load:(n,r)=>l(void 0,null,(function*(){if(2!=c){c=1;const l=yield t();o(l)||""==l?e.transaction((()=>e.setTables(n).setValues(r))):e.setJson(l),c=0}return v})),startAutoLoad:(e,t)=>l(void 0,null,(function*(){return v.stopAutoLoad(),yield v.load(e,t),s(v.load),v})),stopAutoLoad:()=>(i(),v),save:()=>l(void 0,null,(function*(){return 1!=c&&(c=2,yield a(e.getJson()),c=0),v})),startAutoSave:()=>l(void 0,null,(function*(){return yield v.stopAutoSave().save(),u=e.addTablesListener(v.save),d=e.addValuesListener(v.save),v})),stopAutoSave:()=>(n(u,e.delListener),n(d,e.delListener),v),getStore:()=>e,destroy:()=>v.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return r(v)};var s=(e,t,o)=>new Promise(((n,r)=>{var l=e=>{try{s(o.next(e))}catch(e){r(e)}},a=e=>{try{s(o.throw(e))}catch(e){r(e)}},s=e=>e.done?n(e.value):Promise.resolve(e.value).then(l,a);s((o=o.apply(e,t)).next())}));const i=globalThis.window,u=(e,t,o)=>{let n;return a(e,(()=>s(void 0,null,(function*(){return o.getItem(t)}))),(e=>s(void 0,null,(function*(){return o.setItem(t,e)}))),(e=>{n=n=>{n.storageArea===o&&n.key===t&&e()},i.addEventListener("storage",n)}),(()=>{i.removeEventListener("storage",n),n=void 0}))},d=(e,t)=>u(e,t,localStorage),c=(e,t)=>u(e,t,sessionStorage);var v=(e,t,o)=>new Promise(((n,r)=>{var l=e=>{try{s(o.next(e))}catch(e){r(e)}},a=e=>{try{s(o.throw(e))}catch(e){r(e)}},s=e=>e.done?n(e.value):Promise.resolve(e.value).then(l,a);s((o=o.apply(e,t)).next())}));const y=(o,n)=>{let r;return a(o,(()=>v(void 0,null,(function*(){try{return yield t.readFile(n,"utf8")}catch(e){}}))),(e=>v(void 0,null,(function*(){try{yield t.writeFile(n,e,"utf8")}catch(e){}}))),(t=>{r=e(n,t)}),(()=>{null==r||r.close(),r=void 0}))};var h=(e,t,o)=>new Promise(((n,r)=>{var l=e=>{try{s(o.next(e))}catch(e){r(e)}},a=e=>{try{s(o.throw(e))}catch(e){r(e)}},s=e=>e.done?n(e.value):Promise.resolve(e.value).then(l,a);s((o=o.apply(e,t)).next())}));const f=e=>e.headers.get("ETag"),p=(e,t,r,l)=>{let s,i;return a(e,(()=>h(void 0,null,(function*(){const e=yield fetch(t);return i=f(e),e.text()}))),(e=>h(void 0,null,(function*(){return yield fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:e})}))),(e=>{s=setInterval((()=>h(void 0,null,(function*(){const n=yield fetch(t,{method:"HEAD"}),r=f(n);o(i)||o(r)||r==i||(i=r,e())}))),1e3*l)}),(()=>{n(s,clearInterval),s=void 0}))};export{a as createCustomPersister,y as createFilePersister,d as createLocalPersister,p as createRemotePersister,c as createSessionPersister};
