const e=e=>typeof e,t=e(""),r=e(e),n=(e,t)=>e.forEach(t),s=e=>o(e,((e,t)=>e+t),0),i=e=>e.length,o=(e,t,r)=>e.reduce(t,r),a=(e,...t)=>e.push(...t),c=Math.max,d=Math.min,l=isFinite,u=e=>null==e,v=(e,t,r)=>u(e)?r?.():t(e),h=e=>Array.isArray(e),f=()=>{},g=e=>e.size,M=(e,t)=>e?.has(t)??!1,L=e=>u(e)||0==g(e),m=e=>[...e?.values()??[]],w=e=>e.clear(),y=(e,t)=>e?.forEach(t),p=(e,t)=>e?.delete(t),b=e=>new Map(e),x=(e,t)=>e?.get(t),E=(e,t)=>y(e,((e,r)=>t(r,e))),I=(e,t,r)=>u(r)?(p(e,t),e):e?.set(t,r),R=(e,t,r)=>(M(e,t)||I(e,t,r()),x(e,t)),S=(e,t,r,n,s=0)=>v((r?R:x)(e,t[s],s>i(t)-2?r:b),(o=>{if(s>i(t)-2)return n?.(o)&&I(e,t[s]),o;const a=S(o,t,r,n,s+1);return L(o)&&I(e,t[s]),a})),T=b([["avg",[(e,t)=>s(e)/t,(e,t,r)=>e+(t-e)/(r+1),(e,t,r)=>e+(e-t)/(r-1),(e,t,r,n)=>e+(t-r)/n]],["max",[e=>c(...e),(e,t)=>c(t,e),(e,t)=>t==e?void 0:e,(e,t,r)=>r==e?void 0:c(t,e)]],["min",[e=>d(...e),(e,t)=>d(t,e),(e,t)=>t==e?void 0:e,(e,t,r)=>r==e?void 0:d(t,e)]],["sum",[e=>s(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,r)=>e-r+t]]]),k=e=>new Set(h(e)||u(e)?e:[e]),z=(e,t)=>e?.add(t),A=/^\d+$/,D=Object.freeze,N=(s=>{const o=new WeakMap;return s=>(o.has(s)||o.set(s,(s=>{const o=b(),[c,d,N,j,C,F,O,,W,$,q]=((e,t,r)=>{const s=e.hasRow,o=b(),a=b(),c=b(),d=b(),l=b(),f=(t,r,...s)=>{const i=R(l,t,k);return n(s,(t=>z(i,t)&&r&&e.callListener(t))),s},g=(t,...r)=>v(x(l,t),(s=>{n(0==i(r)?m(s):r,(t=>{e.delListener(t),p(s,t)})),L(s)&&I(l,t)})),S=(e,r)=>{I(o,e,r),M(a,e)||(I(a,e,t()),I(c,e,b()),I(d,e,b()))},T=e=>{I(o,e),I(a,e),I(c,e),I(d,e),g(e)};return[()=>e,()=>[...o?.keys()??[]],e=>E(a,e),e=>M(a,e),e=>x(o,e),e=>x(a,e),(e,t)=>I(a,e,t),S,(t,r,o,a,l)=>{S(t,r);const v=b(),L=b(),m=x(c,t),p=x(d,t),R=t=>{const n=n=>e.getCell(r,t,n),o=x(m,t),c=s(r,t)?(d=a(n,t),isNaN(d)||u(d)||!0===d||!1===d||""===d?void 0:1*d):void 0;var d,f,g,M;if(o===c||h(o)&&h(c)&&(g=c,i(f=o)===i(g)&&(M=(e,t)=>g[t]===e,f.every(M)))||I(v,t,[o,c]),!u(l)){const e=x(p,t),i=s(r,t)?l(n,t):void 0;e!=i&&I(L,t,i)}},T=e=>{o((()=>{y(v,(([,e],t)=>I(m,t,e))),y(L,((e,t)=>I(p,t,e)))}),v,L,m,p,e),w(v),w(L)};E(m,R),e.hasTable(r)&&n(e.getRowIds(r),(e=>{M(m,e)||R(e)})),T(!0),g(t),f(t,0,e.addRowListener(r,null,((e,t,r)=>R(r))),e.addTableListener(r,(()=>T())))},T,()=>E(l,T),f,g]})(s,f),[B,G,H]=(e=>{let t;const[r,s]=(()=>{const e=[];let t=0;return[()=>e.shift()??""+t++,t=>{A.test(t)&&i(e)<1e3&&a(e,t)}]})(),o=b();return[(e,n,s,i=[],a=(()=>[]))=>{t??=J;const c=r();return I(o,c,[e,n,s,i,a]),z(S(n,s??[""],k),c),c},(e,r,...s)=>n(((e,t=[""])=>{const r=[],s=(e,o)=>o==i(t)?a(r,e):null===t[o]?y(e,(e=>s(e,o+1))):n([t[o],null],(t=>s(x(e,t),o+1)));return s(e,0),r})(e,r),(e=>y(e,(e=>x(o,e)[0](t,...r??[],...s))))),e=>v(x(o,e),(([,t,r])=>(S(t,r??[""],void 0,(t=>(p(t,e),L(t)?1:0))),I(o,e),s(e),r))),e=>v(x(o,e),(([e,,r=[],s,o])=>{const a=(...c)=>{const d=i(c);d==i(r)?e(t,...c,...o(c)):u(r[d])?n(s[d]?.(...c)??[],(e=>a(...c,e))):a(...c,r[d])};a()}))]})(),J={setMetricDefinition:(n,s,i,a,c,d,v)=>{const h=e(i)==r?[i,c,d,v]:x(T,i)??x(T,"sum");return W(n,s,((e,t,r,s,i,a)=>{const c=F(n),d=g(s);a||=u(c),e();let v=((e,t,r,n,s,i=!1)=>{if(L(r))return;const[o,a,c,d]=s;return i||=u(e),y(n,(([r,n])=>{i||(e=u(r)?a?.(e,n,t++):u(n)?c?.(e,r,t--):d?.(e,n,r,t),i||=u(e))})),i?o(m(r),g(r)):e})(c,d,s,t,h,a);l(v)||(v=void 0),v!=c&&(O(n,v),G(o,[n],v,c))}),(1,e(f=a)==t?e=>e(f):f??(()=>1))),J;var f},delMetricDefinition:e=>($(e),J),getStore:c,getMetricIds:d,forEachMetric:N,hasMetric:j,getTableId:C,getMetric:F,addMetricListener:(e,t)=>B(t,o,[e]),delListener:e=>(H(e),J),destroy:q,getListenerStats:()=>({})};return D(J)})(s)),o.get(s))})();export{N as createMetrics};
