var e,t;e=this,t=function(e,t){"use strict";const o="utf8",n=e=>null==e,r=(e,t,o)=>n(e)?null==o?void 0:o():t(e),s=Object.freeze;var l=(e,t,o)=>new Promise(((n,r)=>{var s=e=>{try{a(o.next(e))}catch(e){r(e)}},l=e=>{try{a(o.throw(e))}catch(e){r(e)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,l);a((o=o.apply(e,t)).next())}));const a=(e,t,o,a,i)=>{let u,d,c=0;const v={load:(o,r)=>l(void 0,null,(function*(){if(2!=c){c=1;const s=yield t();n(s)||""==s?e.transaction((()=>e.setTables(o).setValues(r))):e.setJson(s),c=0}return v})),startAutoLoad:(e,t)=>l(void 0,null,(function*(){return v.stopAutoLoad(),yield v.load(e,t),a(v.load),v})),stopAutoLoad:()=>(i(),v),save:()=>l(void 0,null,(function*(){return 1!=c&&(c=2,yield o(e.getJson()),c=0),v})),startAutoSave:()=>l(void 0,null,(function*(){return yield v.stopAutoSave().save(),u=e.addTablesListener(v.save),d=e.addValuesListener(v.save),v})),stopAutoSave:()=>(r(u,e.delListener),r(d,e.delListener),v),getStore:()=>e,destroy:()=>v.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return s(v)};var i=(e,t,o)=>new Promise(((n,r)=>{var s=e=>{try{a(o.next(e))}catch(e){r(e)}},l=e=>{try{a(o.throw(e))}catch(e){r(e)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,l);a((o=o.apply(e,t)).next())}));const u="storage",d=globalThis.window,c=(e,t,o)=>{let n;return a(e,(()=>i(void 0,null,(function*(){return o.getItem(t)}))),(e=>i(void 0,null,(function*(){return o.setItem(t,e)}))),(e=>{n=n=>{n.storageArea===o&&n.key===t&&e()},d.addEventListener(u,n)}),(()=>{d.removeEventListener(u,n),n=void 0}))};var v=(e,t,o)=>new Promise(((n,r)=>{var s=e=>{try{a(o.next(e))}catch(e){r(e)}},l=e=>{try{a(o.throw(e))}catch(e){r(e)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,l);a((o=o.apply(e,t)).next())})),f=(e,t,o)=>new Promise(((n,r)=>{var s=e=>{try{a(o.next(e))}catch(e){r(e)}},l=e=>{try{a(o.throw(e))}catch(e){r(e)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,l);a((o=o.apply(e,t)).next())}));const y=e=>e.headers.get("ETag");e.createCustomPersister=a,e.createFilePersister=(e,n)=>{let r;return a(e,(()=>v(void 0,null,(function*(){try{return yield t.promises.readFile(n,o)}catch(e){}}))),(e=>v(void 0,null,(function*(){try{yield t.promises.writeFile(n,e,o)}catch(e){}}))),(e=>{r=t.watch(n,e)}),(()=>{null==r||r.close(),r=void 0}))},e.createLocalPersister=(e,t)=>c(e,t,localStorage),e.createRemotePersister=(e,t,o,s)=>{let l,i;return a(e,(()=>f(void 0,null,(function*(){const e=yield fetch(t);return i=y(e),e.text()}))),(e=>f(void 0,null,(function*(){return yield fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:e})}))),(e=>{l=setInterval((()=>f(void 0,null,(function*(){const o=yield fetch(t,{method:"HEAD"}),r=y(o);n(i)||n(r)||r==i||(i=r,e())}))),1e3*s)}),(()=>{r(l,clearInterval),l=void 0}))},e.createSessionPersister=(e,t)=>c(e,t,sessionStorage)},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs")):"function"==typeof define&&define.amd?define(["exports","fs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisters={},e.fs);
