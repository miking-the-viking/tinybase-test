const e=e=>typeof e,t=e(""),n=e(!0),s=e(0),r=e(e),o=(e,t)=>e.every(t),l=(e,t)=>e.forEach(t),a=e=>c(e,((e,t)=>e+t),0),i=e=>e.length,d=e=>0==i(e),c=(e,t,n)=>e.reduce(t,n),u=(e,...t)=>e.push(...t),h=Math.max,w=Math.min,g=isFinite,R=e=>null==e,v=(e,t,n)=>R(e)?n?.():t(e),L=t=>e(t)==r,f=e=>Array.isArray(e),y=()=>{},T=e=>e.size,b=(e,t)=>e?.has(t)??!1,C=e=>R(e)||0==T(e),p=e=>[...e?.values()??[]],I=e=>e.clear(),m=(e,t)=>e?.forEach(t),S=(e,t)=>e?.delete(t),Q=e=>new Map(e),E=(e,t)=>e?.get(t),M=(e,t)=>m(e,((e,n)=>t(n,e))),x=(e,t,n)=>R(n)?(S(e,t),e):e?.set(t,n),D=(e,t,n)=>(b(e,t)||x(e,t,n()),E(e,t)),F=(e,t,n,s,r=0)=>v((n?D:E)(e,t[r],r>i(t)-2?n:Q),(o=>{if(r>i(t)-2)return s?.(o)&&x(e,t[r]),o;const l=F(o,t,n,s,r+1);return C(o)&&x(e,t[r]),l})),j=e=>new Set(f(e)||R(e)?e:[e]),k=(e,t)=>e?.add(t),z=Q([["avg",[(e,t)=>a(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,s)=>e+(t-n)/s]],["max",[e=>h(...e),(e,t)=>h(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:h(t,e)]],["min",[e=>w(...e),(e,t)=>w(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:w(t,e)]],["sum",[e=>a(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),A=Object,W=A.freeze,O=(r=>{const a=new WeakMap;return r=>(a.has(r)||a.set(r,(r=>{const a=r.createStore,[c,h,w,O,q,,,B,,G,H,J,K]=((e,t,n)=>{const s=e.hasRow,r=Q(),a=Q(),c=Q(),u=Q(),h=Q(),w=(t,n,...s)=>{const r=D(h,t,j);return l(s,(t=>k(r,t)&&n&&e.callListener(t))),s},g=(t,...n)=>v(E(h,t),(s=>{l(d(n)?p(s):n,(t=>{e.delListener(t),S(s,t)})),C(s)&&x(h,t)})),L=(e,t)=>{x(r,e,t),b(a,e)||(x(a,e,!0),x(c,e,Q()),x(u,e,Q()))},y=e=>{x(r,e),x(a,e),x(c,e),x(u,e),g(e)};return[()=>e,()=>[...r?.keys()??[]],e=>M(a,e),e=>b(a,e),e=>E(r,e),e=>E(a,e),(e,t)=>x(a,e,t),L,(t,r,a,d,h)=>{L(t,r);const v=Q(),y=Q(),T=E(c,t),C=E(u,t),p=t=>{const l=n=>e.getCell(r,t,n),a=E(T,t),c=s(r,t)?n(d(l,t)):void 0;var u,w;if(a===c||f(a)&&f(c)&&(w=c,i(u=a)===i(w)&&o(u,((e,t)=>w[t]===e)))||x(v,t,[a,c]),!R(h)){const e=E(C,t),n=s(r,t)?h(l,t):void 0;e!=n&&x(y,t,n)}},S=e=>{a((()=>{m(v,(([,e],t)=>x(T,t,e))),m(y,((e,t)=>x(C,t,e)))}),v,y,T,C,e),I(v),I(y)};M(T,p),e.hasTable(r)&&l(e.getRowIds(r),(e=>{b(T,e)||p(e)})),S(!0),g(t),w(t,0,e.addRowListener(r,null,((e,t,n)=>p(n))),e.addTableListener(r,(()=>S())))},y,()=>M(h,y),w,g]})(r,0,y),N=a(),P=a(),U=Q(),V=(e,t,...n)=>l(n,(n=>k(D(D(U,t,Q),e,j),n))),X=e=>{v(E(U,e),(e=>{M(e,((e,t)=>m(t,(t=>e.delListener(t))))),I(e)})),l([P,N],(t=>t.delTable(e)))},Y=(e,t,n)=>V(t,e,t.addWillFinishTransactionListener(n.startTransaction),t.addDidFinishTransactionListener((()=>n.finishTransaction()))),Z={setQueryDefinition:(a,c,h)=>{B(a,c),X(a);const w=[],f=[[null,[c,null,null,[],Q()]]],y=[],I=[],A=[];h({select:(e,t)=>{const n=L(e)?[i(w)+"",e]:[R(t)?e:t,n=>n(e,t)];return u(w,n),{as:e=>n[0]=e}},join:(e,t,n)=>{const s=R(n)||L(t)?null:t,r=R(s)?t:n,o=[e,[e,s,L(r)?r:e=>e(r),[],Q()]];return u(f,o),{as:e=>o[0]=e}},where:(e,t,n)=>u(y,L(e)?e:R(n)?n=>n(e)===t:s=>s(e,t)===n),group:(e,t,n,s,r)=>{const o=[e,[e,L(t)?[t,n,s,r]:E(z,t)??[(e,t)=>t]]];return u(I,o),{as:e=>o[0]=e}},having:(e,t)=>u(A,L(e)?e:n=>n(e)===t)});const W=Q(w);if(C(W))return Z;const O=Q(f);M(O,((e,[,t])=>v(E(O,t),(({3:t})=>R(e)?0:u(t,e)))));const q=Q(I);let G=N;if(C(q)&&d(A))G=P;else{Y(a,G,P);const r=Q();M(q,((e,[t,n])=>k(D(r,t,j),[e,n])));const l=j();M(W,(e=>b(r,e)?0:k(l,e)));const i=Q(),d=(l,i,d,c)=>v(l,(([u,h,w,v])=>{M(i,((o,[l])=>{const a=D(u,o,Q),i=E(a,d),h=c?void 0:l;if(i!==h){const l=j([[i,h]]),c=T(a);x(a,d,h),m(E(r,o),(([r,o])=>{const i=((e,t,n,s,r,o=!1)=>{if(C(n))return;const[l,a,i,d]=r;return o||=R(e),m(s,(([n,s])=>{o||(e=R(n)?a?.(e,s,t++):R(s)?i?.(e,n,t--):d?.(e,s,n,t),o||=R(e))})),o?l(p(n),T(n)):e})(v[r],c,a,l,o);v[r]=R((r=>{const o=e(r);return(e=>e==t||e==n)(o)||o==s&&g(r)?o:void 0})(i))?null:i}))}})),C(h)||!o(A,(e=>e((e=>v[e]))))?P.delRow(a,w):R(w)?l[2]=P.addRow(a,v):P.setRow(a,w,v)}));V(G,a,G.addRowListener(a,null,((e,t,n,s)=>{const o=[],c=[],h=Q(),w=G.hasRow(a,n);let g=!w;m(l,(e=>{const[t,r,l]=s(a,n,e);u(o,r),u(c,l),g||=t})),M(r,(e=>{const[t,,r]=s(a,n,e);(g||t)&&x(h,e,[r])})),g&&d(F(i,o,void 0,(([,e])=>(S(e,n),C(e)))),h,n,1),w&&d(F(i,c,(()=>{const e={};return m(l,(t=>e[t]=G.getCell(a,n,t))),[Q(),j(),void 0,e]}),(([,e])=>{k(e,n)})),h,n)})))}Y(a,r,G);const H=(e,t,n,s)=>{const i=e=>r.getCell(t,n,e);l(s,(t=>{const[n,,s,o,l]=E(O,t),d=s?.(i,e),[c,u]=E(l,e)??[];d!=c&&(R(u)||K(a,u),x(l,e,R(d)?null:[d,...J(a,1,r.addRowListener(n,d,(()=>H(e,n,d,o))))]))})),(e=>{const t=(t,n)=>r.getCell(...R(n)?[c,e,t]:t===c?[c,e,n]:[E(O,t)?.[0],E(E(O,t)?.[4],e)?.[0],n]);G.transaction((()=>o(y,(e=>e(t)))?M(W,((n,s)=>((e,t,n,s,r)=>R(r)?e.delCell(t,n,s,!0):e.setCell(t,n,s,r))(G,a,e,n,s(t,e)))):G.delRow(a,e)))})(e)},{3:U}=E(O,null);return G.transaction((()=>J(a,1,r.addRowListener(c,null,((e,t,n)=>{r.hasRow(c,n)?H(n,c,n,U):(G.delRow(a,n),m(O,(({4:e})=>v(E(e,n),(([,t])=>{K(a,t),x(e,n)})))))}))))),Z},delQueryDefinition:e=>(X(e),G(e),Z),getStore:c,getQueryIds:h,forEachQuery:w,hasQuery:O,getTableId:q,delListener:e=>(P.delListener(e),Z),destroy:H,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:n,...s}=P.getListenerStats();return s}};var $,_;return $={Table:[1,1],RowIds:[0,1],SortedRowIds:[0,5],Row:[1,2],CellIds:[0,2],Cell:[1,3]},_=([e,t],n)=>{l(e?["get","has","forEach"]:["get"],(e=>Z[e+"Result"+n]=(...t)=>P[e+n](...t))),Z["addResult"+n+"Listener"]=(...e)=>{return P["add"+n+"Listener"](...(s=e,0,r=t,s.slice(0,r)),((n,...s)=>e[t](Z,...s)));var s,r}},((e,t)=>{e.map(t)})(A.entries($),(([e,t])=>_(t,e))),W(Z)})(r)),a.get(r))})();export{O as createQueries};
