"use strict";var e=require("fs");const t=e=>null==e,r=(e,r,o)=>t(e)?null==o?void 0:o():r(e),o=Object.freeze;var n=(e,t,r)=>new Promise(((o,n)=>{var s=e=>{try{l(r.next(e))}catch(e){n(e)}},a=e=>{try{l(r.throw(e))}catch(e){n(e)}},l=e=>e.done?o(e.value):Promise.resolve(e.value).then(s,a);l((r=r.apply(e,t)).next())}));const s=(e,s,a,l,i)=>{let u,c,d=0;const v={load:(r,o)=>n(void 0,null,(function*(){if(2!=d){d=1;const n=yield s();t(n)||""==n?e.transaction((()=>e.setTables(r).setValues(o))):e.setJson(n),d=0}return v})),startAutoLoad:(e,t)=>n(void 0,null,(function*(){return v.stopAutoLoad(),yield v.load(e,t),l(v.load),v})),stopAutoLoad:()=>(i(),v),save:()=>n(void 0,null,(function*(){return 1!=d&&(d=2,yield a(e.getJson()),d=0),v})),startAutoSave:()=>n(void 0,null,(function*(){return yield v.stopAutoSave().save(),u=e.addTablesListener(v.save),c=e.addValuesListener(v.save),v})),stopAutoSave:()=>(r(u,e.delListener),r(c,e.delListener),v),getStore:()=>e,destroy:()=>v.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return o(v)};var a=(e,t,r)=>new Promise(((o,n)=>{var s=e=>{try{l(r.next(e))}catch(e){n(e)}},a=e=>{try{l(r.throw(e))}catch(e){n(e)}},l=e=>e.done?o(e.value):Promise.resolve(e.value).then(s,a);l((r=r.apply(e,t)).next())}));const l=globalThis.window,i=(e,t,r)=>{let o;return s(e,(()=>a(void 0,null,(function*(){return r.getItem(t)}))),(e=>a(void 0,null,(function*(){return r.setItem(t,e)}))),(e=>{o=o=>{o.storageArea===r&&o.key===t&&e()},l.addEventListener("storage",o)}),(()=>{l.removeEventListener("storage",o),o=void 0}))};var u=(e,t,r)=>new Promise(((o,n)=>{var s=e=>{try{l(r.next(e))}catch(e){n(e)}},a=e=>{try{l(r.throw(e))}catch(e){n(e)}},l=e=>e.done?o(e.value):Promise.resolve(e.value).then(s,a);l((r=r.apply(e,t)).next())})),c=(e,t,r)=>new Promise(((o,n)=>{var s=e=>{try{l(r.next(e))}catch(e){n(e)}},a=e=>{try{l(r.throw(e))}catch(e){n(e)}},l=e=>e.done?o(e.value):Promise.resolve(e.value).then(s,a);l((r=r.apply(e,t)).next())}));const d=e=>e.headers.get("ETag");exports.createCustomPersister=s,exports.createFilePersister=(t,r)=>{let o;return s(t,(()=>u(void 0,null,(function*(){try{return yield e.promises.readFile(r,"utf8")}catch(e){}}))),(t=>u(void 0,null,(function*(){try{yield e.promises.writeFile(r,t,"utf8")}catch(e){}}))),(t=>{o=e.watch(r,t)}),(()=>{null==o||o.close(),o=void 0}))},exports.createLocalPersister=(e,t)=>i(e,t,localStorage),exports.createRemotePersister=(e,o,n,a)=>{let l,i;return s(e,(()=>c(void 0,null,(function*(){const e=yield fetch(o);return i=d(e),e.text()}))),(e=>c(void 0,null,(function*(){return yield fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:e})}))),(e=>{l=setInterval((()=>c(void 0,null,(function*(){const r=yield fetch(o,{method:"HEAD"}),n=d(r);t(i)||t(n)||n==i||(i=n,e())}))),1e3*a)}),(()=>{r(l,clearInterval),l=void 0}))},exports.createSessionPersister=(e,t)=>i(e,t,sessionStorage);
