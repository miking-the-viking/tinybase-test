"use strict";const e=(e,n)=>e.includes(n),n=(e,n)=>e.forEach(n),t=e=>e.length,l=e=>0==t(e),r=(e,...n)=>e.push(...n),o=e=>e.pop(),s=e=>e.shift(),u=e=>null==e,i=(e,n,t)=>u(e)?null==t?void 0:t():n(e),d=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},c=e=>u(e)||0==(e=>e.size)(e),a=(e,n)=>null==e?void 0:e.forEach(n),h=(e,n)=>null==e?void 0:e.delete(n),v=e=>new Map(e),p=(e,n)=>null==e?void 0:e.get(n),C=(e,n,t)=>u(t)?(h(e,n),e):null==e?void 0:e.set(n,t),k=(e,n,t)=>(d(e,n)||C(e,n,t()),p(e,n)),f=(e,n,l,r,o=0)=>i((l?k:p)(e,n[o],o>t(n)-2?l:v),(s=>{if(o>t(n)-2)return(null==r?void 0:r(s))&&C(e,n[o]),s;const u=f(s,n,l,r,o+1);return c(s)&&C(e,n[o]),u})),g=e=>new Set(Array.isArray(e)||u(e)?e:[e]),L=/^\d+$/,w=Object.freeze,S=(S=>{const y=new WeakMap;return S=>(y.has(S)||y.set(S,(S=>{let y,z,E,V=100,A=v(),I=v(),M=1;const b=v(),j=v(),[x,B,F]=(e=>{let l;const[o,d]=(()=>{const e=[];let n=0;return[()=>{var t;return null!=(t=s(e))?t:""+n++},n=>{L.test(n)&&t(e)<1e3&&r(e,n)}]})(),k=v();return[(e,n,t,r=[],s=(()=>[]))=>{null!=l||(l=_);const u=o();var i,d;return C(k,u,[e,n,t,r,s]),d=u,null==(i=f(n,null!=t?t:[""],g))||i.add(d),u},(e,o,...s)=>n(((e,l=[""])=>{const o=[],s=(e,u)=>u==t(l)?r(o,e):null===l[u]?a(e,(e=>s(e,u+1))):n([l[u],null],(n=>s(p(e,n),u+1)));return s(e,0),o})(e,o),(e=>a(e,(e=>p(k,e)[0](l,...null!=o?o:[],...s))))),e=>i(p(k,e),(([,n,t])=>(f(n,null!=t?t:[""],void 0,(n=>(h(n,e),c(n)?1:0))),C(k,e),d(e),t))),e=>i(p(k,e),(([e,,r=[],o,s])=>{const i=(...d)=>{var c,a;const h=t(d);h==t(r)?e(l,...d,...s(d)):u(r[h])?n(null!=(a=null==(c=o[h])?void 0:c.call(o,...d))?a:[],(e=>i(...d,e))):i(...d,r[h])};i()}))]})(),O=v(),T=v(),W=[],$=[],m=(e,n)=>{M=0,S.transaction((()=>{const[t,l]=p(O,n);a(t,((n,t)=>a(n,((n,l)=>a(n,((n,r)=>((e,n,t,l,r)=>u(r)?e.delCell(n,t,l,!0):e.setCell(n,t,l,r))(S,t,l,r,n[e]))))))),a(l,((n,t)=>((e,n,t)=>u(t)?e.delValue(n):e.setValue(n,t))(S,t,n[e])))})),M=1},q=e=>{C(O,e),C(T,e),B(j,[e])},D=(e,l)=>n(((e,n)=>e.splice(0,n))(e,null!=l?l:t(e)),q),G=()=>D(W,t(W)-V),H=()=>i(y,(()=>{r(W,y),G(),D($),y=void 0,E=1})),J=()=>{y=o(W),E=1},K=S.addCellListener(null,null,null,((e,n,t,l,r,o)=>{if(M){H();const e=k(A,n,v),s=k(e,t,v),u=k(s,l,(()=>[o,void 0]));u[1]=r,u[0]===r&&c(C(s,l))&&c(C(e,t))&&c(C(A,n))&&J(),U()}})),N=S.addValueListener(null,((e,n,t,l)=>{if(M){H();const e=k(I,n,(()=>[l,void 0]));e[1]=t,e[0]===t&&c(C(I,n))&&J(),U()}})),P=(e="")=>(u(y)&&(y=""+z++,C(O,y,[A,I]),Y(y,e),A=v(),I=v(),E=1),y),Q=()=>{l(W)||(((e,...n)=>{e.unshift(...n)})($,P()),m(0,y),y=o(W),E=1)},R=()=>{l($)||(r(W,y),y=s($),m(1,y),E=1)},U=()=>{E&&(B(b),E=0)},X=e=>{const n=P(e);return U(),n},Y=(e,n)=>(Z(e)&&p(T,e)!==n&&(C(T,e,n),B(j,[e])),_),Z=e=>d(O,e),_={setSize:e=>(V=e,G(),_),addCheckpoint:X,setCheckpoint:Y,getStore:()=>S,getCheckpointIds:()=>[[...W],y,[...$]],forEachCheckpoint:e=>{return n=e,a(T,((e,t)=>n(t,e)));var n},hasCheckpoint:Z,getCheckpoint:e=>p(T,e),goBackward:()=>(Q(),U(),_),goForward:()=>(R(),U(),_),goTo:n=>{const t=e(W,n)?Q:e($,n)?R:null;for(;!u(t)&&n!=y;)t();return U(),_},addCheckpointIdsListener:e=>x(e,b),addCheckpointListener:(e,n)=>x(n,j,[e]),delListener:e=>(F(e),_),clear:()=>(D(W),D($),u(y)||q(y),y=void 0,z=0,X(),_),destroy:()=>{S.delListener(K),S.delListener(N)},getListenerStats:()=>({})};return w(_.clear())})(S)),y.get(S))})();exports.createCheckpoints=S;
