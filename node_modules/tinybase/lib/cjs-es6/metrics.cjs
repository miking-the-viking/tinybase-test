"use strict";const e=e=>typeof e,t=e(""),n=e(e),l=(e,t)=>e.forEach(t),r=e=>o(e,((e,t)=>e+t),0),i=e=>e.length,o=(e,t,n)=>e.reduce(t,n),s=(e,...t)=>e.push(...t),u=Math.max,d=Math.min,a=isFinite,c=e=>null==e,v=(e,t,n)=>c(e)?null==n?void 0:n():t(e),h=e=>Array.isArray(e),M=()=>{},f=e=>e.size,g=(e,t)=>{var n;return null!=(n=null==e?void 0:e.has(t))&&n},L=e=>c(e)||0==f(e),m=e=>{var t;return[...null!=(t=null==e?void 0:e.values())?t:[]]},w=e=>e.clear(),y=(e,t)=>null==e?void 0:e.forEach(t),p=(e,t)=>null==e?void 0:e.delete(t),b=e=>new Map(e),x=(e,t)=>null==e?void 0:e.get(t),E=(e,t)=>y(e,((e,n)=>t(n,e))),I=(e,t,n)=>c(n)?(p(e,t),e):null==e?void 0:e.set(t,n),R=(e,t,n)=>(g(e,t)||I(e,t,n()),x(e,t)),S=(e,t,n,l,r=0)=>v((n?R:x)(e,t[r],r>i(t)-2?n:b),(o=>{if(r>i(t)-2)return(null==l?void 0:l(o))&&I(e,t[r]),o;const s=S(o,t,n,l,r+1);return L(o)&&I(e,t[r]),s})),T=b([["avg",[(e,t)=>r(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,l)=>e+(t-n)/l]],["max",[e=>u(...e),(e,t)=>u(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:u(t,e)]],["min",[e=>d(...e),(e,t)=>d(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:d(t,e)]],["sum",[e=>r(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),k=e=>new Set(h(e)||c(e)?e:[e]),z=(e,t)=>null==e?void 0:e.add(t),A=/^\d+$/,D=Object.freeze,N=(r=>{const o=new WeakMap;return r=>(o.has(r)||o.set(r,(r=>{const o=b(),[u,d,N,j,C,F,O,,W,$,q]=((e,t,n)=>{const r=e.hasRow,o=b(),s=b(),u=b(),d=b(),a=b(),M=(t,n,...r)=>{const i=R(a,t,k);return l(r,(t=>z(i,t)&&n&&e.callListener(t))),r},f=(t,...n)=>v(x(a,t),(r=>{l(0==i(n)?m(r):n,(t=>{e.delListener(t),p(r,t)})),L(r)&&I(a,t)})),S=(e,n)=>{I(o,e,n),g(s,e)||(I(s,e,t()),I(u,e,b()),I(d,e,b()))},T=e=>{I(o,e),I(s,e),I(u,e),I(d,e),f(e)};return[()=>e,()=>{return[...null!=(t=null==(e=o)?void 0:e.keys())?t:[]];var e,t},e=>E(s,e),e=>g(s,e),e=>x(o,e),e=>x(s,e),(e,t)=>I(s,e,t),S,(t,n,o,s,a)=>{S(t,n);const v=b(),L=b(),m=x(u,t),p=x(d,t),R=t=>{const l=l=>e.getCell(n,t,l),o=x(m,t),u=r(n,t)?(d=s(l,t),isNaN(d)||c(d)||!0===d||!1===d||""===d?void 0:1*d):void 0;var d,M,f,g;if(o===u||h(o)&&h(u)&&(f=u,i(M=o)===i(f)&&(g=(e,t)=>f[t]===e,M.every(g)))||I(v,t,[o,u]),!c(a)){const e=x(p,t),i=r(n,t)?a(l,t):void 0;e!=i&&I(L,t,i)}},T=e=>{o((()=>{y(v,(([,e],t)=>I(m,t,e))),y(L,((e,t)=>I(p,t,e)))}),v,L,m,p,e),w(v),w(L)};E(m,R),e.hasTable(n)&&l(e.getRowIds(n),(e=>{g(m,e)||R(e)})),T(!0),f(t),M(t,0,e.addRowListener(n,null,((e,t,n)=>R(n))),e.addTableListener(n,(()=>T())))},T,()=>E(a,T),M,f]})(r,M),[B,G,H]=(e=>{let t;const[n,r]=(()=>{const e=[];let t=0;return[()=>{var n;return null!=(n=e.shift())?n:""+t++},t=>{A.test(t)&&i(e)<1e3&&s(e,t)}]})(),o=b();return[(e,l,r,i=[],s=(()=>[]))=>{null!=t||(t=J);const u=n();return I(o,u,[e,l,r,i,s]),z(S(l,null!=r?r:[""],k),u),u},(e,n,...r)=>l(((e,t=[""])=>{const n=[],r=(e,o)=>o==i(t)?s(n,e):null===t[o]?y(e,(e=>r(e,o+1))):l([t[o],null],(t=>r(x(e,t),o+1)));return r(e,0),n})(e,n),(e=>y(e,(e=>x(o,e)[0](t,...null!=n?n:[],...r))))),e=>v(x(o,e),(([,t,n])=>(S(t,null!=n?n:[""],void 0,(t=>(p(t,e),L(t)?1:0))),I(o,e),r(e),n))),e=>v(x(o,e),(([e,,n=[],r,o])=>{const s=(...u)=>{var d,a;const v=i(u);v==i(n)?e(t,...u,...o(u)):c(n[v])?l(null!=(a=null==(d=r[v])?void 0:d.call(r,...u))?a:[],(e=>s(...u,e))):s(...u,n[v])};s()}))]})(),J={setMetricDefinition:(l,r,i,s,u,d,v)=>{var h;const M=e(i)==n?[i,u,d,v]:null!=(h=x(T,i))?h:x(T,"sum");return W(l,r,((e,t,n,r,i,s)=>{const u=F(l),d=f(r);s||(s=c(u)),e();let v=((e,t,n,l,r,i=!1)=>{if(L(n))return;const[o,s,u,d]=r;return i||(i=c(e)),y(l,(([n,l])=>{i||(e=c(n)?null==s?void 0:s(e,l,t++):c(l)?null==u?void 0:u(e,n,t--):null==d?void 0:d(e,l,n,t),i||(i=c(e)))})),i?o(m(n),f(n)):e})(u,d,r,t,M,s);a(v)||(v=void 0),v!=u&&(O(l,v),G(o,[l],v,u))}),(1,e(g=s)==t?e=>e(g):null!=g?g:()=>1)),J;var g},delMetricDefinition:e=>($(e),J),getStore:u,getMetricIds:d,forEachMetric:N,hasMetric:j,getTableId:C,getMetric:F,addMetricListener:(e,t)=>B(t,o,[e]),delListener:e=>(H(e),J),destroy:q,getListenerStats:()=>({})};return D(J)})(r)),o.get(r))})();exports.createMetrics=N;
