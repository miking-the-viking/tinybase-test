import{promises as t,watch as e}from"fs";const a=t=>null==t,s=(t,e,s)=>a(t)?s?.():e(t),o=Object.freeze,r=(t,e,r,n,c)=>{let i,d,l=0;const u={load:async(s,o)=>{if(2!=l){l=1;const r=await e();a(r)||""==r?t.transaction((()=>t.setTables(s).setValues(o))):t.setJson(r),l=0}return u},startAutoLoad:async(t,e)=>(u.stopAutoLoad(),await u.load(t,e),n(u.load),u),stopAutoLoad:()=>(c(),u),save:async()=>(1!=l&&(l=2,await r(t.getJson()),l=0),u),startAutoSave:async()=>(await u.stopAutoSave().save(),i=t.addTablesListener(u.save),d=t.addValuesListener(u.save),u),stopAutoSave:()=>(s(i,t.delListener),s(d,t.delListener),u),getStore:()=>t,destroy:()=>u.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return o(u)},n=globalThis.window,c=(t,e,a)=>{let s;return r(t,(async()=>a.getItem(e)),(async t=>a.setItem(e,t)),(t=>{s=s=>{s.storageArea===a&&s.key===e&&t()},n.addEventListener("storage",s)}),(()=>{n.removeEventListener("storage",s),s=void 0}))},i=(t,e)=>c(t,e,localStorage),d=(t,e)=>c(t,e,sessionStorage),l=(a,s)=>{let o;return r(a,(async()=>{try{return await t.readFile(s,"utf8")}catch{}}),(async e=>{try{await t.writeFile(s,e,"utf8")}catch{}}),(t=>{o=e(s,t)}),(()=>{o?.close(),o=void 0}))},u=t=>t.headers.get("ETag"),y=(t,e,o,n)=>{let c,i;return r(t,(async()=>{const t=await fetch(e);return i=u(t),t.text()}),(async t=>await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:t})),(t=>{c=setInterval((async()=>{const s=await fetch(e,{method:"HEAD"}),o=u(s);a(i)||a(o)||o==i||(i=o,t())}),1e3*n)}),(()=>{s(c,clearInterval),c=void 0}))};export{r as createCustomPersister,l as createFilePersister,i as createLocalPersister,y as createRemotePersister,d as createSessionPersister};
